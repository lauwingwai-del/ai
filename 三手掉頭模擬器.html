<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英國三手軚掉頭模擬器</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; margin: 0; overflow-x: hidden; }
        .car-shadow { filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // 模擬 Lucide 圖標組件
        const Icon = ({ name, size = 20, className = "" }) => {
            const [svg, setSvg] = useState("");
            useEffect(() => {
                if (window.lucide) {
                    const iconSvg = lucide.createIcons();
                }
            }, []);
            // 使用簡單的 SVG 代替部分圖標以確保離線可用性
            const icons = {
                ArrowLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
                ArrowRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
                RefreshCcw: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
                ChevronLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>,
                ChevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>,
                Eye: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
            };
            return icons[name] || null;
        };

        const App = () => {
            const stepsData = [
                { id: 1, message: "第一手：打右燈，入 D 波。按住 D 鍵前進，右扭軚使車頭靠近石壆 A。", hint: "目標：車頭轉向 A 壆" },
                { id: 2, message: "第二手：打左燈，入 R 波。左扭軚並按 D/F 鍵後退，利用 6.3m 的軸距轉向。", hint: "目標：車尾轉向 B 壆，車身打橫" },
                { id: 3, message: "第三手：打右燈，入 D 波。右扭軚前進駛離。", hint: "目標：回正並駛離" }
            ];

            const initialState = {
                step: 1, 
                indicator: null,
                gear: 'P',
                handbrake: true,
                steeringAngle: 0, 
                carPosition: { x: 80, y: 65, theta: Math.PI }, 
                success: false,
                isAccelerating: false,
                isReversing: false
            };

            const [step, setStep] = useState(initialState.step);
            const [indicator, setIndicator] = useState(initialState.indicator);
            const [gear, setGear] = useState(initialState.gear);
            const [handbrake, setHandbrake] = useState(initialState.handbrake);
            const [steeringAngle, setSteeringAngle] = useState(initialState.steeringAngle);
            const [carPosition, setCarPosition] = useState(initialState.carPosition); 
            const [message, setMessage] = useState(stepsData[0].message);
            const [success, setSuccess] = useState(initialState.success);
            const [isAccelerating, setIsAccelerating] = useState(false);
            const [isReversing, setIsReversing] = useState(false);
            
            const L = 25;           
            const v_speed = 0.4;    
            const dt = 1;           

            const goToNextStep = useCallback(() => {
                if (step < 3) {
                    const nextStep = step + 1;
                    setStep(nextStep);
                    setMessage(stepsData[nextStep - 1].message);
                    setHandbrake(true); 
                }
            }, [step]);

            const goToPrevStep = useCallback(() => {
                if (step > 1) {
                    const prevStep = step - 1;
                    setStep(prevStep);
                    setMessage(stepsData[prevStep - 1].message);
                    setHandbrake(true);
                }
            }, [step]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    const key = e.key.toLowerCase();
                    if (key === 'd') setIsAccelerating(true);
                    if (key === 'f') setIsReversing(true);
                    if (e.key === 'ArrowLeft') setSteeringAngle(prev => Math.max(-540, prev - 45));
                    if (e.key === 'ArrowRight') setSteeringAngle(prev => Math.min(540, prev + 45));
                };
                const handleKeyUp = (e) => {
                    const key = e.key.toLowerCase();
                    if (key === 'd') setIsAccelerating(false);
                    if (key === 'f') setIsReversing(false);
                };
                window.addEventListener('keydown', handleKeyDown);
                window.addEventListener('keyup', handleKeyUp);
                return () => {
                    window.removeEventListener('keydown', handleKeyDown);
                    window.removeEventListener('keyup', handleKeyUp);
                };
            }, []);

            useEffect(() => {
                const timer = setInterval(() => {
                    setCarPosition(prev => {
                        if (handbrake || gear === 'P' || gear === 'N') return prev;
                        let v = 0;
                        if (isAccelerating && gear === 'D') v = v_speed;
                        else if (isReversing || (isAccelerating && gear === 'R')) v = -v_speed;
                        if (v === 0) return prev;

                        const phi = (steeringAngle / 540) * 0.6;
                        const dTheta = (v / L) * Math.tan(phi) * dt;
                        const newTheta = prev.theta + dTheta;
                        const newX = prev.x + (v * Math.cos(newTheta) * dt);
                        const newY = prev.y + (v * Math.sin(newTheta) * dt);

                        if (newX < 5 || newX > 95 || newY < 23 || newY > 77) {
                            setMessage("咚！碰撞石壆。請注意長車身的掃空範圍。");
                            setHandbrake(true);
                            setIsAccelerating(false);
                            setIsReversing(false);
                            return prev;
                        }
                        return { x: newX, y: newY, theta: newTheta };
                    });
                }, 30);
                return () => clearInterval(timer);
            }, [handbrake, gear, steeringAngle, isAccelerating, isReversing]);

            const handleReset = () => {
                setStep(initialState.step);
                setIndicator(initialState.indicator);
                setGear(initialState.gear);
                setHandbrake(initialState.handbrake);
                setSteeringAngle(initialState.steeringAngle);
                setCarPosition(initialState.carPosition);
                setMessage(stepsData[0].message);
                setSuccess(initialState.success);
                setIsAccelerating(false);
                setIsReversing(false);
            };

            const checkProgress = useCallback(() => {
                let deg = (carPosition.theta * 180 / Math.PI) % 360;
                if (deg < 0) deg += 360;

                if (step === 1) {
                    if (indicator === 'right' && gear === 'D' && !handbrake && steeringAngle > 400 && carPosition.y > 72) {
                        goToNextStep();
                    }
                } else if (step === 2) {
                    if (indicator === 'left' && (gear === 'R' || isReversing) && !handbrake && Math.abs(steeringAngle) < 150 && (deg < 15 || deg > 345) && carPosition.y < 28) {
                        goToNextStep();
                    }
                } else if (step === 3) {
                    if (indicator === 'right' && gear === 'D' && !handbrake && carPosition.x < 15) {
                        setSuccess(true);
                        setMessage("成功完成！");
                    }
                }
            }, [step, indicator, gear, handbrake, steeringAngle, carPosition, isReversing, goToNextStep]);

            useEffect(() => { checkProgress(); }, [checkProgress]);

            return (
                <div className="min-h-screen bg-slate-900 text-white font-sans p-4 flex flex-col items-center">
                    <header className="w-full max-w-4xl flex justify-between items-center mb-4 bg-slate-800 p-4 rounded-xl shadow-lg border border-slate-700">
                        <div className="flex flex-col">
                            <h1 className="text-xl font-bold text-yellow-500 italic uppercase tracking-widest">三手掉頭模擬器</h1>
                            <span className="text-[10px] text-slate-400 font-mono italic">步驟控制系統 (離線單檔案版)</span>
                        </div>
                        <div className="flex gap-2 text-white">
                            <button onClick={goToPrevStep} disabled={step === 1} className={`px-3 py-2 rounded-lg text-xs font-bold transition-all border border-white/5 flex items-center gap-1 ${step === 1 ? 'opacity-30 cursor-not-allowed bg-slate-800' : 'bg-slate-700 hover:bg-slate-600'}`}>
                                <Icon name="ChevronLeft" size={14} /> 上一步
                            </button>
                            <button onClick={goToNextStep} disabled={step === 3} className={`px-3 py-2 rounded-lg text-xs font-bold transition-all border border-white/5 flex items-center gap-1 ${step === 3 ? 'opacity-30 cursor-not-allowed bg-slate-800' : 'bg-slate-700 hover:bg-slate-600'}`}>
                                下一步 <Icon name="ChevronRight" size={14} />
                            </button>
                            <button onClick={handleReset} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs font-bold transition-all border border-white/5 flex items-center gap-1 ml-2">
                                <Icon name="RefreshCcw" size={14} /> 重設
                            </button>
                        </div>
                    </header>

                    <main className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="md:col-span-2 space-y-4">
                            <div className="relative h-[440px] bg-slate-700 rounded-3xl overflow-hidden border-4 border-slate-800 shadow-2xl">
                                <div className="absolute inset-0 bg-gray-600">
                                    <div className="absolute top-0 w-full h-[20%] bg-stone-500 border-b-4 border-stone-600 z-20 flex items-center justify-center">
                                        <div className="absolute bottom-0 w-full h-2 bg-yellow-400"></div>
                                        <span className="text-[9px] text-white/30 font-black tracking-widest uppercase">Kerb A</span>
                                    </div>
                                    <div className="absolute bottom-0 w-full h-[20%] bg-stone-500 border-t-4 border-stone-600 z-20 flex items-center justify-center">
                                        <div className="absolute top-0 w-full h-2 bg-yellow-400"></div>
                                        <span className="text-[9px] text-white/30 font-black tracking-widest uppercase">Kerb B</span>
                                    </div>
                                </div>

                                <div 
                                    className="absolute transition-all duration-100 ease-linear z-30"
                                    style={{ 
                                        width: '128px', 
                                        height: '48px', 
                                        left: `${carPosition.x}%`, 
                                        top: `${carPosition.y}%`, 
                                        transform: `translate(-50%, -50%) rotate(${carPosition.theta * 180 / Math.PI}deg)` 
                                    }}
                                >
                                    <div className="absolute inset-0 bg-indigo-950 rounded-lg border-2 border-indigo-400 shadow-2xl">
                                        <div className="absolute right-4 top-1 bottom-1 w-6 bg-sky-100/20 rounded-sm"></div>
                                    </div>
                                    <div className="absolute -right-1 -top-1 w-7 h-3 bg-black rounded-sm origin-left" style={{ transform: `rotate(${steeringAngle/16}deg)` }}></div>
                                    <div className="absolute -right-1 -bottom-1 w-7 h-3 bg-black rounded-sm origin-left" style={{ transform: `rotate(${steeringAngle/16}deg)` }}></div>
                                    <div className="absolute -left-1 -top-1 w-7 h-3 bg-black rounded-sm"></div>
                                    <div className="absolute -left-1 -bottom-1 w-7 h-3 bg-black rounded-sm"></div>
                                    
                                    {indicator === 'right' && <div className="absolute -bottom-3 right-4 w-4 h-4 bg-orange-500 rounded-full animate-pulse z-40 shadow-[0_0_10px_orange]"></div>}
                                    {indicator === 'left' && <div className="absolute -top-3 right-4 w-4 h-4 bg-orange-500 rounded-full animate-pulse z-40 shadow-[0_0_10px_orange]"></div>}
                                </div>

                                <div className="absolute bottom-10 left-1/2 -translate-x-1/2 w-[85%] bg-black/90 backdrop-blur-md p-5 rounded-3xl text-center border border-white/10 z-40">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1 tracking-widest flex items-center justify-center gap-2">
                                        <span className="px-2 py-0.5 bg-yellow-500 text-black rounded-md">第 {step} 步</span>
                                        <span>{stepsData[step-1].hint}</span>
                                    </div>
                                    <div className="text-xs text-yellow-500 font-medium leading-relaxed">
                                        {message}
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-3 gap-3">
                                <div className="bg-slate-800 p-3 rounded-2xl border border-slate-700 text-center shadow-lg">
                                    <span className="text-[9px] font-black text-slate-500 block mb-1 uppercase">X-Axis</span>
                                    <div className="text-xs font-mono text-white">{carPosition.x.toFixed(1)}</div>
                                </div>
                                <div className="bg-slate-800 p-3 rounded-2xl border border-slate-700 text-center shadow-lg">
                                    <span className="text-[9px] font-black text-slate-500 block mb-1 uppercase">朝向</span>
                                    <div className="text-xs font-mono text-yellow-500 tracking-tighter">
                                        {((carPosition.theta * 180 / Math.PI) % 360).toFixed(1)}°
                                    </div>
                                </div>
                                <div className="bg-slate-800 p-3 rounded-2xl border border-slate-700 text-center shadow-lg">
                                    <span className="text-[9px] font-black text-slate-500 block mb-1 uppercase">Y-Axis</span>
                                    <div className="text-xs font-mono text-white">{carPosition.y.toFixed(1)}</div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-slate-800 p-6 rounded-[2.5rem] shadow-2xl border border-slate-700 flex flex-col gap-6">
                            <div className="flex flex-col items-center">
                                <div 
                                    className="relative w-44 h-44 rounded-full border-[14px] border-slate-950 flex items-center justify-center shadow-2xl bg-slate-900 transition-transform duration-150 ease-out"
                                    style={{ transform: `rotate(${steeringAngle}deg)` }}
                                >
                                    <div className="absolute w-full h-4 bg-slate-950"></div>
                                    <div className="absolute w-4 h-full bg-slate-950"></div>
                                    <div className="w-16 h-16 rounded-full bg-slate-800 border-4 border-slate-700 z-20 flex items-center justify-center shadow-inner">
                                        <span className="text-2xl font-black text-yellow-500 select-none">M</span>
                                    </div>
                                    <div className="absolute top-1 w-2 h-6 bg-red-600 rounded-full z-10 shadow-[0_0_10px_red]"></div>
                                </div>
                                <div className="mt-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                                   <span className="w-2 h-2 rounded-full bg-yellow-500"></span>
                                   扭軚角度: {steeringAngle}°
                                </div>
                            </div>

                            <div className="bg-slate-950 p-6 rounded-3xl border border-slate-700 flex justify-between items-center shadow-inner">
                                <div className="flex flex-col gap-1.5">
                                    {['P', 'R', 'N', 'D'].map(g => (
                                        <button 
                                            key={g} 
                                            onClick={() => setGear(g)} 
                                            className={`w-12 h-8 rounded-lg text-[10px] font-black transition-all ${gear === g ? 'bg-yellow-500 text-black scale-110 shadow-lg' : 'bg-slate-800 text-slate-500 hover:text-white'}`}
                                        >
                                            {g}
                                        </button>
                                    ))}
                                </div>

                                <div className="flex flex-col items-center gap-2">
                                    <button 
                                        onClick={() => setHandbrake(!handbrake)} 
                                        className={`w-14 h-24 rounded-2xl transition-all duration-500 border-t-2 border-white/5 ${handbrake ? 'bg-red-700 shadow-[0_0_20px_rgba(185,28,28,0.3)]' : 'bg-slate-800 translate-y-4 opacity-40'}`}
                                    >
                                        <div className={`w-1.5 h-6 mx-auto mt-2 rounded-full ${handbrake ? 'bg-red-400 animate-pulse' : 'bg-slate-600'}`}></div>
                                    </button>
                                    <span className={`text-[8px] font-black ${handbrake ? 'text-red-500' : 'text-green-500'}`}>{handbrake ? '手掣已拉' : '可以起步'}</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <button 
                                    onClick={() => setIndicator(indicator === 'left' ? null : 'left')} 
                                    className={`py-4 rounded-2xl flex flex-col items-center gap-1 border-2 transition-all ${indicator === 'left' ? 'bg-orange-500/20 border-orange-500 text-orange-400 shadow-lg' : 'bg-slate-900 border-transparent text-slate-500'}`}
                                >
                                    <Icon name="ArrowLeft" />
                                    <span className="text-[9px] font-bold uppercase tracking-tight">左燈 (L)</span>
                                </button>
                                <button 
                                    onClick={() => setIndicator(indicator === 'right' ? null : 'right')} 
                                    className={`py-4 rounded-2xl flex flex-col items-center gap-1 border-2 transition-all ${indicator === 'right' ? 'bg-orange-500/20 border-orange-500 text-orange-400 shadow-lg' : 'bg-slate-900 border-transparent text-slate-500'}`}
                                >
                                    <Icon name="ArrowRight" />
                                    <span className="text-[9px] font-bold uppercase tracking-tight">右燈 (R)</span>
                                </button>
                            </div>
                            
                            <div className="p-4 bg-slate-900/50 rounded-2xl border border-slate-700 flex flex-col gap-2">
                                <div className="flex justify-between items-center text-[10px]">
                                    <span className="font-bold text-slate-400 italic font-mono">GAS (D Key)</span>
                                    <div className={`w-3 h-3 rounded-full ${isAccelerating ? 'bg-green-500 animate-pulse shadow-[0_0_10px_green]' : 'bg-slate-700'}`}></div>
                                </div>
                                <div className="flex justify-between items-center text-[10px]">
                                    <span className="font-bold text-slate-400 italic font-mono">REV (F Key)</span>
                                    <div className={`w-3 h-3 rounded-full ${isReversing ? 'bg-blue-500 animate-pulse shadow-[0_0_10px_blue]' : 'bg-slate-700'}`}></div>
                                </div>
                            </div>
                        </div>
                    </main>

                    {success && (
                        <div className="fixed inset-0 bg-slate-950/98 backdrop-blur-3xl flex items-center justify-center z-50 p-6 text-white">
                            <div className="bg-slate-800 border-2 border-yellow-500/50 p-12 rounded-[3rem] max-w-sm w-full text-center shadow-2xl">
                                <div className="w-16 h-16 bg-yellow-500 rounded-full mx-auto mb-6 flex items-center justify-center shadow-lg">
                                    <Icon name="Eye" size={32} className="text-black" />
                                </div>
                                <h2 className="text-3xl font-black mb-2 italic">合格!</h2>
                                <p className="text-slate-400 text-sm mb-10 leading-relaxed">模擬測試完成，你已成功學會三手掉頭的正確程序。</p>
                                <button onClick={handleReset} className="w-full py-5 bg-yellow-500 text-black font-black rounded-xl hover:scale-105 transition-all text-[10px] tracking-widest uppercase">重開挑戰</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>