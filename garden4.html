<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æœˆä¸‹èŠ±åœ’ - æº«æƒ…å®ˆæœ›ç‰ˆ</title>
    <!-- å¼•å…¥ MediaPipe Hands åº« -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- ä½¿ç”¨ Tailwind CSS é€²è¡Œæ¨£å¼è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Google Fonts ç”¨æ–¼è©©å¥å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Noto Sans TC', sans-serif;
        }

        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* ç•«å¸ƒé¡åƒç¿»è½‰ï¼Œè®“æ“ä½œç¬¦åˆç›´è¦º */
        canvas {
            display: block;
            transform: scaleX(-1); 
        }

        /* éš±è—åŸå§‹è¦–é »å…ƒç´  */
        .input_video {
            display: none;
        }

        /* UI æ§ä»¶æ¨£å¼ */
        .ui-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
            box-shadow: 0 6px 8px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 20;
            flex-direction: column;
        }

        .instruction {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.8);
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.7), transparent);
            padding: 10px 40px;
            border-radius: 20px;
            pointer-events: none;
            text-align: center;
            z-index: 5;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        /* éŸ³æ¨‚æ§åˆ¶å€ */
        .music-player {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-end;
        }
    </style>
</head>
<body>

    <div id="canvas-container">
        <!-- ç•«å¸ƒ -->
        <canvas id="output_canvas"></canvas>
        
        <!-- è¦–é »è¼¸å…¥ (éš±è—) -->
        <video class="input_video"></video>

        <!-- UI æ§ä»¶ -->
        <div class="ui-controls">
            <div class="music-player">
                <label class="btn">
                    <span>ğŸµ ä¸Šè¼‰èƒŒæ™¯éŸ³æ¨‚</span>
                    <input type="file" id="music-upload" accept="audio/*" style="display: none;">
                </label>
                <!-- æ’­æ”¾æ§åˆ¶æŒ‰éˆ• -->
                <button class="btn" id="music-toggle" style="display: none; background-color: rgba(100, 255, 100, 0.3);">
                    â–¶ï¸ æ’­æ”¾éŸ³æ¨‚
                </button>
            </div>
            
            <button class="btn" onclick="flowers = [];">
                ğŸ§¹ æ¸…é™¤èŠ±åœ’
            </button>
        </div>

        <!-- æŒ‡å¼•æ–‡å­— -->
        <div class="instruction">
            <p class="text-xl font-light tracking-widest">æåˆæ‰‹æŒ‡æŠ“å–ç¨®å­ Â· æ”¾é–‹æ‰‹æŒ‡ç¶»æ”¾å¥‡è¹Ÿ</p>
        </div>

        <!-- åŠ è¼‰ç•«é¢ -->
        <div class="loading-overlay" id="loading">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div>
            <p>æ­£åœ¨å•Ÿå‹• AI è¦–è¦ºå¼•æ“...</p>
            <p class="text-sm text-gray-400 mt-2">è«‹å…è¨±æ”åƒé ­æ¬Šé™</p>
        </div>
    </div>

    <audio id="bg-music" loop></audio>

    <script>
        // --- è®Šé‡å®šç¾© ---
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingScreen = document.getElementById('loading');
        
        // éŸ³é »æ§åˆ¶
        const musicUpload = document.getElementById('music-upload');
        const musicToggle = document.getElementById('music-toggle');
        const bgMusic = document.getElementById('bg-music');
        let isMusicPlaying = false;

        // æ‡‰ç”¨ç‹€æ…‹
        let width, height;
        let particles = []; // æµæ˜Ÿ
        let flowers = [];   // èŠ±æœµ
        let stars = [];     // èƒŒæ™¯æ˜Ÿæ˜Ÿ
        let snail;          // è¸ç‰›
        let handPosition = { x: 0, y: 0, pinch: false };
        let lastPinchState = false; 

        // --- åˆå§‹åŒ– ---
        function resize() {
            width = canvasElement.width = window.innerWidth;
            height = canvasElement.height = window.innerHeight;
            initStars();
            // åˆå§‹åŒ–è¸ç‰›ä½ç½®
            if (!snail) snail = new Snail();
            snail.y = height - 30; // ç¢ºä¿è¸ç‰›åœ¨åº•éƒ¨
        }
        window.addEventListener('resize', resize);
        
        // --- è¦–è¦ºå…ƒç´ é¡åˆ¥ ---

        // 1. èƒŒæ™¯æ˜Ÿæ˜Ÿ
        function initStars() {
            stars = [];
            for(let i=0; i<150; i++) {
                stars.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    size: Math.random() * 1.5,
                    alpha: Math.random(),
                    twinkleSpeed: 0.02 + Math.random() * 0.05
                });
            }
        }

        // 2. æµæ˜Ÿ
        class Meteor {
            constructor() {
                this.reset();
            }
            reset() {
                this.x = Math.random() * width;
                this.y = Math.random() * height * 0.4; 
                this.len = Math.random() * 80 + 20;
                this.speed = Math.random() * 15 + 10;
                this.size = Math.random() * 2 + 0.5;
                this.angle = Math.PI / 4; 
                this.opacity = 0;
                this.active = false;
                if(Math.random() < 0.01) this.active = true;
            }
            update() {
                if(!this.active) {
                    if(Math.random() < 0.008) { 
                        this.active = true;
                        this.opacity = 1;
                        this.x = Math.random() * width;
                        this.y = -100;
                    }
                    return;
                }

                this.x -= this.speed * Math.cos(this.angle); 
                this.y += this.speed * Math.sin(this.angle); 
                this.opacity -= 0.02;

                if (this.y > height || this.x < 0 || this.opacity <= 0) {
                    this.active = false;
                }
            }
            draw() {
                if(!this.active) return;
                canvasCtx.save();
                const grad = canvasCtx.createLinearGradient(this.x, this.y, this.x + this.len * Math.cos(this.angle), this.y - this.len * Math.sin(this.angle));
                grad.addColorStop(0, `rgba(255, 255, 255, ${this.opacity})`);
                grad.addColorStop(1, `rgba(255, 255, 255, 0)`);
                
                canvasCtx.strokeStyle = grad;
                canvasCtx.lineWidth = this.size;
                canvasCtx.lineCap = 'round';
                canvasCtx.beginPath();
                canvasCtx.moveTo(this.x, this.y);
                canvasCtx.lineTo(this.x + this.len * Math.cos(this.angle), this.y - this.len * Math.sin(this.angle)); 
                canvasCtx.stroke();
                
                canvasCtx.shadowBlur = 15;
                canvasCtx.shadowColor = '#FFFFFF';
                canvasCtx.restore();
            }
        }

        for(let i=0; i<6; i++) particles.push(new Meteor());

        // 3. è¸ç‰›é¡åˆ¥
        class Snail {
            constructor() {
                this.x = 0;
                this.y = 0;
                this.size = 20;
                this.speed = 0.5;
                this.direction = 1; 
                this.wobble = 0;
            }

            update() {
                this.x += this.speed * this.direction;
                this.wobble += 0.1;
                // é‚Šç•Œæª¢æŸ¥
                if (this.x > width + 50) this.direction = -1;
                else if (this.x < -50) this.direction = 1;
            }

            draw() {
                canvasCtx.save();
                canvasCtx.translate(this.x, this.y);
                
                // è™•ç†é¡åƒå’Œæ–¹å‘
                // å…ˆæŠµæ¶ˆä¸»ç•«å¸ƒçš„é¡åƒ
                canvasCtx.scale(-1, 1);
                // æ ¹æ“šè¡Œèµ°æ–¹å‘ç¿»è½‰
                if (this.direction === 1) canvasCtx.scale(-1, 1); 

                // èº«é«”
                canvasCtx.fillStyle = '#D2B48C'; 
                canvasCtx.beginPath();
                canvasCtx.ellipse(0, 5, this.size, this.size * 0.4, 0, 0, Math.PI * 2);
                canvasCtx.fill();

                // é ­éƒ¨
                canvasCtx.beginPath();
                canvasCtx.arc(this.size * 0.8, -this.size * 0.2, this.size * 0.4, 0, Math.PI * 2);
                canvasCtx.fill();

                // è§¸è§’
                canvasCtx.strokeStyle = '#D2B48C';
                canvasCtx.lineWidth = 2;
                canvasCtx.beginPath();
                canvasCtx.moveTo(this.size * 1.0, -this.size * 0.5);
                canvasCtx.lineTo(this.size * 1.2, -this.size * 1.0);
                canvasCtx.moveTo(this.size * 0.6, -this.size * 0.5);
                canvasCtx.lineTo(this.size * 0.8, -this.size * 1.0);
                canvasCtx.stroke();

                // æ®¼
                canvasCtx.fillStyle = '#8B4513';
                canvasCtx.beginPath();
                canvasCtx.arc(0, -this.size * 0.5, this.size * 0.7, 0, Math.PI * 2);
                canvasCtx.fill();
                
                // èºæ—‹ç´‹
                canvasCtx.strokeStyle = '#DEB887';
                canvasCtx.lineWidth = 2;
                canvasCtx.beginPath();
                for (let i = 0; i < 3; i++) {
                     canvasCtx.arc(0, -this.size * 0.5, this.size * 0.2 * (i+1), 0, Math.PI + i, false);
                }
                canvasCtx.stroke();
                canvasCtx.restore();
            }
        }

        // 4. èŠ±æœµé¡åˆ¥
        class Flower {
            constructor(x) {
                this.x = x;
                this.y = height;
                this.targetHeight = Math.random() * 250 + 150;
                this.currentHeight = 0;
                
                // 0: æ«»èŠ±, 1: å‘æ—¥è‘µ, 2: ç«ç‘°, 3: è–°è¡£è‰
                this.type = Math.floor(Math.random() * 4); 

                if (this.type === 0) { // æ«»èŠ±
                    this.petalColor = '#FFC0CB'; 
                    this.centerColor = '#D81B60'; 
                    this.stemColor = '#5D4037';   
                    this.maxBloomSize = 30 + Math.random() * 5;
                } else if (this.type === 1) { // å‘æ—¥è‘µ
                    this.petalColor = '#FFD700'; 
                    this.centerColor = '#4B3621'; 
                    this.stemColor = '#228B22';   
                    this.maxBloomSize = 45 + Math.random() * 10;
                } else if (this.type === 2) { // ç«ç‘°
                    const r = Math.random();
                    this.petalColor = r < 0.5 ? '#DC143C' : (r < 0.8 ? '#FF69B4' : '#FFF0F5');
                    this.stemColor = '#006400'; 
                    this.maxBloomSize = 35 + Math.random() * 8;
                } else { // è–°è¡£è‰
                    this.petalColor = Math.random() > 0.5 ? '#9370DB' : '#7B68EE'; 
                    this.stemColor = '#556B2F'; 
                    this.maxBloomSize = 50; 
                }
                this.currentBloomSize = 0;
                this.swaySpeed = 0.001 + Math.random() * 0.002;
                this.swayOffset = Math.random() * Math.PI * 2;
                this.leafLeft = Math.random() > 0.2;
                this.leafRight = Math.random() > 0.2;
            }

            update() {
                if (this.currentHeight < this.targetHeight) {
                    this.currentHeight += (this.targetHeight - this.currentHeight) * 0.05;
                } 
                if (this.currentHeight > this.targetHeight * 0.6) {
                     if (this.currentBloomSize < this.maxBloomSize) {
                        this.currentBloomSize += (this.maxBloomSize - this.currentBloomSize) * 0.04;
                    }
                }
            }

            draw() {
                canvasCtx.save();
                const sway = Math.sin(Date.now() * this.swaySpeed + this.swayOffset) * 10;
                const tipX = this.x + sway;
                const tipY = height - this.currentHeight;

                canvasCtx.strokeStyle = this.stemColor;
                canvasCtx.lineCap = 'round';
                
                // ç•«è–
                if (this.type === 1) { 
                    canvasCtx.lineWidth = 6;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(this.x, height);
                    canvasCtx.quadraticCurveTo(this.x + sway/4, height - this.currentHeight/2, tipX, tipY);
                    canvasCtx.stroke();
                } else if (this.type === 3) { 
                    canvasCtx.lineWidth = 3;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(this.x, height);
                    canvasCtx.lineTo(tipX, tipY);
                    canvasCtx.stroke();
                } else { 
                    canvasCtx.lineWidth = 4;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(this.x, height);
                    canvasCtx.quadraticCurveTo(this.x + sway/2, height - this.currentHeight/2, tipX, tipY);
                    canvasCtx.stroke();
                }

                // ç•«è‘‰å­ (å‘ä¸Šç”Ÿé•·)
                if (this.currentHeight > 60) {
                    canvasCtx.fillStyle = this.stemColor;
                    if (this.type === 1) { 
                        this.drawHeartLeaf(this.x + sway*0.2 - 5, height - this.currentHeight * 0.4, -0.8, 25);
                        this.drawHeartLeaf(this.x + sway*0.2 + 5, height - this.currentHeight * 0.5, 0.8, 25);
                    } else if (this.type === 2) { 
                         if (this.leafLeft) this.drawSerratedLeaf(this.x + sway*0.2, height - this.currentHeight * 0.3, -1, 12);
                         if (this.leafRight) this.drawSerratedLeaf(this.x + sway*0.2, height - this.currentHeight * 0.5, 1, 12);
                    } else if (this.type === 3) { 
                         this.drawThinLeaf(this.x, height - 30, -0.6, 18);
                         this.drawThinLeaf(this.x, height - 30, 0.6, 18);
                         this.drawThinLeaf(this.x, height - 50, -0.5, 14);
                         this.drawThinLeaf(this.x, height - 50, 0.5, 14);
                    } else { 
                        if (this.leafLeft) this.drawGenericLeaf(this.x + sway/3 - 5, height - this.currentHeight * 0.3, -1, 10);
                        if (this.leafRight) this.drawGenericLeaf(this.x + sway/3 + 5, height - this.currentHeight * 0.5, 1, 10);
                    }
                }

                // ç•«èŠ±
                if (this.currentBloomSize > 1) {
                    canvasCtx.translate(tipX, tipY);
                    if (this.type === 0) { // æ«»èŠ±
                        canvasCtx.rotate(sway * 0.02);
                        canvasCtx.fillStyle = this.petalColor;
                        for(let i=0; i<5; i++) {
                            canvasCtx.save();
                            canvasCtx.rotate(i * Math.PI * 2 / 5);
                            canvasCtx.beginPath();
                            const s = this.currentBloomSize;
                            canvasCtx.moveTo(0,0);
                            canvasCtx.bezierCurveTo(-s*0.3, -s*0.3, -s*0.8, -s*0.8, 0, -s * 1.2); 
                            canvasCtx.lineTo(0, -s * 1.0); canvasCtx.lineTo(0, -s * 1.2);
                            canvasCtx.bezierCurveTo(s*0.8, -s*0.8, s*0.3, -s*0.3, 0, 0);
                            canvasCtx.fill();
                            canvasCtx.restore();
                        }
                        canvasCtx.fillStyle = '#FF69B4'; canvasCtx.beginPath(); canvasCtx.arc(0, 0, this.currentBloomSize * 0.15, 0, Math.PI*2); canvasCtx.fill();
                        canvasCtx.strokeStyle = this.centerColor; canvasCtx.fillStyle = '#FFFF00'; canvasCtx.lineWidth = 1;
                        for(let j=0; j<5; j++){
                            canvasCtx.save(); canvasCtx.rotate(j * Math.PI * 2 / 5 + Math.PI/5); 
                            canvasCtx.beginPath(); canvasCtx.moveTo(0,0); canvasCtx.lineTo(0, this.currentBloomSize * 0.4); canvasCtx.stroke();
                            canvasCtx.beginPath(); canvasCtx.arc(0, this.currentBloomSize * 0.4, 2, 0, Math.PI*2); canvasCtx.fill(); canvasCtx.restore();
                        }
                    } else if (this.type === 1) { // å‘æ—¥è‘µ
                        canvasCtx.rotate(sway * 0.01 + Math.PI/4); 
                        canvasCtx.fillStyle = this.petalColor;
                        for(let i=0; i<18; i++) {
                            canvasCtx.rotate(Math.PI * 2 / 18);
                            canvasCtx.beginPath();
                            canvasCtx.ellipse(0, -this.currentBloomSize*0.66, this.currentBloomSize*0.25, this.currentBloomSize*0.66, 0, 0, Math.PI*2);
                            canvasCtx.fill();
                        }
                        canvasCtx.fillStyle = this.centerColor; canvasCtx.beginPath(); canvasCtx.arc(0, 0, this.currentBloomSize * 0.5, 0, Math.PI*2); canvasCtx.fill();
                        canvasCtx.strokeStyle = 'rgba(0,0,0,0.3)'; canvasCtx.lineWidth = 1; canvasCtx.beginPath();
                        for(let r=5; r < this.currentBloomSize * 0.5; r+=5) { canvasCtx.moveTo(r, 0); canvasCtx.arc(0, 0, r, 0, Math.PI*2); } canvasCtx.stroke();
                    } else if (this.type === 2) { // ç«ç‘°
                        canvasCtx.rotate(sway * 0.02);
                        canvasCtx.fillStyle = this.petalColor; canvasCtx.strokeStyle = 'rgba(0,0,0,0.15)'; canvasCtx.lineWidth = 1;
                        for(let i=0; i<3; i++) { canvasCtx.save(); canvasCtx.rotate(i * Math.PI * 2 / 3); canvasCtx.beginPath(); canvasCtx.arc(0, -this.currentBloomSize * 0.4, this.currentBloomSize * 0.6, 0, Math.PI, true); canvasCtx.fill(); canvasCtx.stroke(); canvasCtx.restore(); }
                        canvasCtx.save(); canvasCtx.rotate(Math.PI/3); for(let i=0; i<3; i++) { canvasCtx.save(); canvasCtx.rotate(i * Math.PI * 2 / 3); canvasCtx.beginPath(); canvasCtx.arc(0, -this.currentBloomSize * 0.3, this.currentBloomSize * 0.4, 0, Math.PI, true); canvasCtx.fill(); canvasCtx.stroke(); canvasCtx.restore(); } canvasCtx.restore();
                        canvasCtx.fillStyle = this.petalColor; canvasCtx.beginPath(); canvasCtx.arc(0, 0, this.currentBloomSize * 0.35, 0, Math.PI * 2); canvasCtx.fill();
                        canvasCtx.strokeStyle = '#8B0000'; canvasCtx.lineWidth = 1.5; canvasCtx.beginPath();
                        for(let r=2; r < this.currentBloomSize * 0.3; r+=3) { canvasCtx.moveTo(r, 0); canvasCtx.arc(0, 0, r, 0, Math.PI * 1.5); } canvasCtx.stroke();
                    } else if (this.type === 3) { // è–°è¡£è‰
                        canvasCtx.rotate(-sway * 0.02); canvasCtx.fillStyle = this.petalColor;
                        const spikeHeight = this.currentBloomSize * 1.5;
                        for(let i=0; i<10; i++) {
                            const yPos = -i * (spikeHeight/10); const scale = 1 - (i / 10) * 0.6; const wid = 8 * scale; const hgt = 10 * scale;
                            canvasCtx.beginPath(); canvasCtx.ellipse(-wid/1.5, yPos, wid, hgt, -0.3, 0, Math.PI*2); canvasCtx.fill();
                            canvasCtx.beginPath(); canvasCtx.ellipse(wid/1.5, yPos, wid, hgt, 0.3, 0, Math.PI*2); canvasCtx.fill();
                            canvasCtx.beginPath(); canvasCtx.ellipse(0, yPos - 2, wid, hgt, 0, 0, Math.PI*2); canvasCtx.fill();
                        }
                    }
                    canvasCtx.restore();
                }
                canvasCtx.restore();
            }

            drawHeartLeaf(x, y, dir, size) {
                canvasCtx.save(); canvasCtx.translate(x, y); canvasCtx.rotate(dir * 0.8); 
                canvasCtx.beginPath(); canvasCtx.moveTo(0,0);
                // Yè»¸åè½‰ï¼Œå‘ä¸Šç”Ÿé•·
                canvasCtx.bezierCurveTo(-size, size*0.5, -size, -size*1.5, 0, -size*2.0);
                canvasCtx.bezierCurveTo(size, -size*1.5, size, size*0.5, 0, 0);
                canvasCtx.fill(); canvasCtx.strokeStyle = 'rgba(0,0,0,0.2)'; canvasCtx.lineWidth = 1; canvasCtx.stroke(); canvasCtx.restore();
            }
            drawSerratedLeaf(x, y, dir, size) {
                canvasCtx.save(); canvasCtx.translate(x, y); canvasCtx.rotate(dir * 1.0); 
                canvasCtx.beginPath(); canvasCtx.moveTo(0,0);
                const steps = 5; const len = size * 2;
                for(let i=1; i<=steps; i++) { let lx = -size/2 * Math.sin(i/steps * Math.PI); let ly = -i * (len/steps); canvasCtx.lineTo(lx, ly); canvasCtx.lineTo(lx + 2, ly + 2); } canvasCtx.lineTo(0, -len - 5);
                for(let i=steps; i>=1; i--) { let rx = size/2 * Math.sin(i/steps * Math.PI); let ly = -i * (len/steps); canvasCtx.lineTo(rx + 2, ly + 2); canvasCtx.lineTo(rx, ly); }
                canvasCtx.closePath(); canvasCtx.fill(); canvasCtx.restore();
            }
            drawThinLeaf(x, y, dir, size) {
                canvasCtx.save(); canvasCtx.translate(x, y); canvasCtx.rotate(dir * 0.8); 
                canvasCtx.beginPath(); canvasCtx.ellipse(0, -size, size/6, size * 1.2, 0, 0, Math.PI*2); canvasCtx.fill(); canvasCtx.restore();
            }
            drawGenericLeaf(x, y, dir, size) {
                canvasCtx.save(); canvasCtx.translate(x, y); canvasCtx.rotate(dir * 0.8); 
                canvasCtx.beginPath(); canvasCtx.ellipse(0, -size/2, size, size/2, Math.PI/2, 0, Math.PI*2); canvasCtx.fill(); canvasCtx.restore();
            }
        }

        // 5. ç¹ªè£½è¼ªæ¤…å°æœ‹å‹ (æ›´æ–°ç‚ºç´°ç¯€ç‰ˆ)
        function drawWheelchairChild() {
            canvasCtx.save();
            
            // ä½ç½®è¨­å®šï¼šè¦–è¦ºå³ä¸‹æ–¹
            // ç”±æ–¼ CSS scaleX(-1)ï¼Œè¦–è¦ºå³å´å°æ‡‰é‚è¼¯ X åº§æ¨™è¼ƒå°çš„å€¼
            // ä¸” child æ‡‰è©²é¢å‘æœˆäº® (visual left / logical right)
            const x = 150; // é‚è¼¯åº§æ¨™ (Visual Right)
            const y = height - 120; // åœ°é¢é«˜åº¦
            const scale = 1.3;

            canvasCtx.translate(x, y);
            canvasCtx.scale(scale, scale);

            // 1. é™°å½± (Shadow)
            canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            canvasCtx.beginPath();
            canvasCtx.ellipse(0, 45, 45, 10, 0, 0, Math.PI * 2);
            canvasCtx.fill();

            // å®šç¾©é¡è‰²
            const colors = {
                metal: '#A9A9A9', // DarkGray
                plastic: '#2F4F4F', // DarkSlateGray
                tire: '#111',
                hoodie: '#00BFFF', // DeepSkyBlue (Bright)
                pants: '#4682B4', // SteelBlue
                skin: '#FFDAB9', // PeachPuff
                hair: '#4A3728'  // Dark Brown
            };

            // å…‰æºï¼šé‚è¼¯ä¸Šä¾†è‡ªå³ä¸Šæ–¹ (width - 100)ï¼Œå³ Moon
            // åœ¨ scaleX(-1) ä¸‹ï¼Œç‰©é«”é¢å‘å³å´ (Moon)
            // æ‰€ä»¥ Highlight åœ¨å³å´

            // 2. é è™•è¼ªå­ (Far Wheel) - è¼ƒæš—
            canvasCtx.save();
            canvasCtx.translate(-25, 10); // Offset for perspective
            drawWheel(colors.tire, '#444', 35);
            canvasCtx.restore();

            // 3. æ¤…å­ä¸»é«”çµæ§‹ (Frame/Seat)
            canvasCtx.fillStyle = colors.plastic;
            // åº§ä½ (Cube/Rect)
            canvasCtx.fillRect(-20, -10, 45, 10);
            // é èƒŒ (Backrest)
            canvasCtx.fillRect(-25, -50, 10, 50);
            // æ‰¶æ‰‹ (Armrest)
            canvasCtx.fillStyle = colors.metal;
            canvasCtx.fillRect(-20, -25, 45, 5);

            // 4. å°æœ‹å‹èº«é«” (Body)
            
            // è…¿éƒ¨ (Legs) - åœ“æŸ±æ„Ÿ
            canvasCtx.fillStyle = colors.pants;
            // å¤§è…¿
            canvasCtx.beginPath();
            canvasCtx.moveTo(0, -10);
            canvasCtx.lineTo(35, -5);
            canvasCtx.lineTo(35, 10);
            canvasCtx.lineTo(0, 10);
            canvasCtx.fill();
            // å°è…¿
            canvasCtx.beginPath();
            canvasCtx.moveTo(35, 0);
            canvasCtx.lineTo(40, 35); // è…³è¸æ¿ä½ç½®
            canvasCtx.lineTo(25, 35);
            canvasCtx.lineTo(25, 0);
            canvasCtx.fill();
            // è…³è¸æ¿
            canvasCtx.fillStyle = '#333';
            canvasCtx.fillRect(20, 35, 25, 5);

            // è»€å¹¹ (Torso) - ç¨å¾®å‰å‚¾ï¼Œç©¿è‘—äº®è‰²å¸½è¡«
            canvasCtx.fillStyle = colors.hoodie;
            canvasCtx.beginPath();
            canvasCtx.moveTo(-15, -10); // è‡€éƒ¨å¾Œ
            canvasCtx.quadraticCurveTo(-10, -50, 5, -55); // èƒŒéƒ¨æ›²ç·š
            canvasCtx.lineTo(25, -45); // è‚©è†€
            canvasCtx.lineTo(20, -5); // è…¹éƒ¨
            canvasCtx.fill();
            // èƒŒéƒ¨æ‘ºç—•ç´°ç¯€
            canvasCtx.strokeStyle = 'rgba(0,0,0,0.1)';
            canvasCtx.lineWidth = 2;
            canvasCtx.beginPath();
            canvasCtx.moveTo(-5, -40);
            canvasCtx.quadraticCurveTo(0, -30, -5, -20);
            canvasCtx.stroke();

            // æ‰‹è‡‚ (Arms) - æ”¾é¬†åœ¨æ‰¶æ‰‹ä¸Š
            canvasCtx.fillStyle = colors.hoodie; // è¢–å­
            canvasCtx.beginPath();
            canvasCtx.ellipse(10, -30, 8, 20, Math.PI/6, 0, Math.PI*2); // ä¸Šè‡‚
            canvasCtx.fill();
            canvasCtx.beginPath();
            canvasCtx.ellipse(15, -15, 6, 18, -Math.PI/6, 0, Math.PI*2); // å‰è‡‚
            canvasCtx.fill();
            // æ‰‹ (Hand)
            canvasCtx.fillStyle = colors.skin;
            canvasCtx.beginPath();
            canvasCtx.arc(22, -8, 6, 0, Math.PI*2);
            canvasCtx.fill();

            // é ­éƒ¨ (Head) - çƒé«”
            // è„–å­
            canvasCtx.fillStyle = colors.skin;
            canvasCtx.fillRect(10, -58, 10, 10);
            // é ­
            canvasCtx.beginPath();
            canvasCtx.arc(18, -70, 16, 0, Math.PI * 2);
            canvasCtx.fill();
            
            // é ­é«® (Hair) - èƒŒå½±ç´°ç¯€
            canvasCtx.fillStyle = colors.hair;
            canvasCtx.beginPath();
            canvasCtx.arc(16, -72, 17, 0, Math.PI * 2); // åŸºç¤é«®å‹
            canvasCtx.fill();
            // é«®æ¢¢å±¤æ¬¡
            canvasCtx.beginPath();
            canvasCtx.moveTo(5, -65);
            canvasCtx.quadraticCurveTo(15, -55, 25, -65);
            canvasCtx.lineTo(30, -75);
            canvasCtx.quadraticCurveTo(15, -90, 0, -75);
            canvasCtx.fill();

            // 5. è¿‘è™•è¼ªå­ (Near Wheel) - è©³ç›¡ç´°ç¯€
            canvasCtx.save();
            canvasCtx.translate(0, 10);
            drawWheel(colors.tire, colors.metal, 38, true);
            canvasCtx.restore();
            
            // 6. å‰è¼ª (Front Wheel)
            canvasCtx.save();
            canvasCtx.translate(40, 40);
            drawWheel(colors.tire, '#555', 12, true);
            canvasCtx.restore();

            // 7. é‚Šç·£å…‰ (Rim Light) - ä¾†è‡ªæœˆäº® (Logical Right/Top)
            // åœ¨ç‰©é«”å³å´é‚Šç·£ç•«äº®å…‰
            canvasCtx.strokeStyle = 'rgba(255, 255, 220, 0.5)';
            canvasCtx.lineWidth = 2;
            canvasCtx.lineCap = 'round';
            
            // é ­é ‚å…‰
            canvasCtx.beginPath(); canvasCtx.arc(18, -70, 16, -Math.PI/2, 0); canvasCtx.stroke();
            // è‚©è†€å…‰
            canvasCtx.beginPath(); canvasCtx.moveTo(10, -55); canvasCtx.quadraticCurveTo(20, -55, 28, -45); canvasCtx.stroke();
            // è†è“‹/è…¿å…‰
            canvasCtx.beginPath(); canvasCtx.moveTo(25, -5); canvasCtx.lineTo(35, -5); canvasCtx.lineTo(40, 20); canvasCtx.stroke();
            // è¼ªæ¤…é‡‘å±¬åå…‰
            canvasCtx.beginPath(); canvasCtx.moveTo(-20, -25); canvasCtx.lineTo(25, -25); canvasCtx.stroke();

            canvasCtx.restore();
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç•«è¼ªå­
        function drawWheel(tireColor, rimColor, radius, spokes = false) {
            // è¼ªèƒ
            canvasCtx.lineWidth = 4;
            canvasCtx.strokeStyle = tireColor;
            canvasCtx.beginPath();
            canvasCtx.arc(0, 0, radius, 0, Math.PI * 2);
            canvasCtx.stroke();
            
            // è¼ªæ¡†
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = rimColor;
            canvasCtx.beginPath();
            canvasCtx.arc(0, 0, radius - 4, 0, Math.PI * 2);
            canvasCtx.stroke();

            // è¼»æ¢
            if (spokes) {
                canvasCtx.lineWidth = 1;
                canvasCtx.strokeStyle = 'rgba(200, 200, 200, 0.5)';
                canvasCtx.beginPath();
                for (let i = 0; i < 8; i++) {
                    const angle = i * (Math.PI / 4);
                    canvasCtx.moveTo(0, 0);
                    canvasCtx.lineTo(Math.cos(angle) * (radius - 4), Math.sin(angle) * (radius - 4));
                }
                canvasCtx.stroke();
            }
        }

        // --- ä¸»ç¹ªåœ–å¾ªç’° ---
        function drawScene() {
            // èƒŒæ™¯
            canvasCtx.fillStyle = 'black';
            canvasCtx.fillRect(0, 0, width, height);

            // æ˜Ÿæ˜Ÿ
            stars.forEach(star => {
                canvasCtx.fillStyle = `rgba(255, 255, 255, ${star.alpha * (0.5 + Math.sin(Date.now() * star.twinkleSpeed) * 0.5)})`;
                canvasCtx.beginPath();
                canvasCtx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                canvasCtx.fill();
            });

            // æœˆäº® (è¦–è¦ºå·¦ä¸Šï¼Œé‚è¼¯å³ä¸Š)
            // èª¿æ•´ä½ç½®ä»¥å®¹ç´è¶…å¤§æœˆäº®ï¼Œé¿å…è²¼é‚Š
            const moonX = width - 180; 
            const moonY = 180;
            // å†æ¬¡æ”¾å¤§å°ºå¯¸ (è¶…ç´šæœˆäº®)
            const moonRadius = 120; 
            const glowRadius = 300; 
            
            const glow = canvasCtx.createRadialGradient(moonX, moonY, moonRadius * 0.8, moonX, moonY, glowRadius);
            glow.addColorStop(0, 'rgba(255, 255, 240, 0.4)');
            glow.addColorStop(1, 'rgba(255, 255, 240, 0)');
            canvasCtx.fillStyle = glow;
            canvasCtx.beginPath(); canvasCtx.arc(moonX, moonY, glowRadius, 0, Math.PI * 2); canvasCtx.fill();
            
            canvasCtx.fillStyle = '#FFFFF0'; canvasCtx.shadowColor = '#FFFFF0'; canvasCtx.shadowBlur = 15;
            canvasCtx.beginPath(); canvasCtx.arc(moonX, moonY, moonRadius, 0, Math.PI * 2); canvasCtx.fill(); canvasCtx.shadowBlur = 0; 
            
            // ç¹ªè£½è©©å¥
            canvasCtx.save();
            canvasCtx.translate(width / 2, 60);
            canvasCtx.scale(-1, 1); // ç¿»è½‰æ–‡å­—
            canvasCtx.font = "bold 24px 'Noto Serif TC', serif";
            canvasCtx.fillStyle = "rgba(255, 255, 255, 0.9)";
            canvasCtx.textAlign = "center";
            canvasCtx.shadowColor = "rgba(255, 255, 255, 0.5)";
            canvasCtx.shadowBlur = 10;
            canvasCtx.fillText("æœˆé›–æ®˜ã€äº®å¦‚é›ªï¼Œé«˜æ›å¤©ç©ºèª°ç¬‘ç¼º", 0, 0);
            canvasCtx.restore();

            // æµæ˜Ÿ
            particles.forEach(p => { p.update(); p.draw(); });

            // ç¹ªè£½è¼ªæ¤…å°æœ‹å‹
            drawWheelchairChild();

            // èŠ±æœµ
            flowers.forEach(flower => { flower.update(); flower.draw(); });
            
            // è¸ç‰›
            if (snail) { snail.update(); snail.draw(); }

            // æ‰‹å‹¢è¦–è¦ºåé¥‹
            if (handPosition.visible) {
                const x = handPosition.x * width;
                const y = handPosition.y * height;

                canvasCtx.shadowBlur = 15;
                canvasCtx.shadowColor = handPosition.pinch ? '#00FF88' : '#FF77FF';
                
                if (handPosition.pinch) {
                    canvasCtx.fillStyle = '#CCFFCC';
                    canvasCtx.beginPath(); canvasCtx.arc(x, y, 8 + Math.sin(Date.now()*0.02)*2, 0, Math.PI * 2); canvasCtx.fill();
                    canvasCtx.font = "24px Arial"; canvasCtx.fillStyle = "white";
                    canvasCtx.save(); canvasCtx.scale(-1, 1); canvasCtx.fillText("ğŸŒ±", -x - 10, y - 30); canvasCtx.restore();
                } else {
                    canvasCtx.strokeStyle = `rgba(255, 255, 255, 0.8)`; canvasCtx.lineWidth = 2;
                    canvasCtx.setLineDash([4, 4]); canvasCtx.beginPath(); canvasCtx.arc(x, y, 25, 0, Math.PI * 2); canvasCtx.stroke(); canvasCtx.setLineDash([]);
                    canvasCtx.fillStyle = 'white'; canvasCtx.beginPath(); canvasCtx.arc(x, y, 4, 0, Math.PI * 2); canvasCtx.fill();
                }
                canvasCtx.shadowBlur = 0;
            }
        }

        // --- MediaPipe é‚è¼¯ ---
        function onResults(results) {
            loadingScreen.style.display = 'none';
            handPosition.visible = false;
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const thumbTip = landmarks[4];
                const indexTip = landmarks[8];
                const distance = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
                const isPinching = distance < 0.06;
                handPosition = { x: indexTip.x, y: indexTip.y, pinch: isPinching, visible: true };
                if (lastPinchState === true && isPinching === false) { plantFlower(handPosition.x * width); }
                lastPinchState = isPinching;
            }
            drawScene();
        }

        function plantFlower(x) {
            if (flowers.length > 40) flowers.shift();
            flowers.push(new Flower(x));
        }

        const hands = new Hands({locateFile: (file) => { return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`; }});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 1280, height: 720
        });
        camera.start();

        // --- éŸ³é » ---
        musicUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                bgMusic.src = url; bgMusic.play(); isMusicPlaying = true;
                musicToggle.style.display = 'flex'; musicToggle.style.backgroundColor = ''; musicToggle.innerHTML = 'â¸ï¸ æš«åœéŸ³æ¨‚';
            }
        });

        musicToggle.addEventListener('click', function() {
            if (bgMusic.src) {
                if (bgMusic.paused) { bgMusic.play(); musicToggle.innerHTML = 'â¸ï¸ æš«åœéŸ³æ¨‚'; } else { bgMusic.pause(); musicToggle.innerHTML = 'â–¶ï¸ æ’­æ”¾éŸ³æ¨‚'; }
            } else { musicUpload.click(); }
        });

        resize();
    </script>
</body>
</html>