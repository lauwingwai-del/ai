<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æœˆä¸‹èŠ±åœ’ - å‘ä¸Šç”Ÿé•·ç‰ˆ</title>
    <!-- å¼•å…¥ MediaPipe Hands åº« -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- ä½¿ç”¨ Tailwind CSS é€²è¡Œæ¨£å¼è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Noto Sans TC', sans-serif;
        }

        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        canvas {
            display: block;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
        }

        /* éš±è—åŸå§‹è¦–é »å…ƒç´  */
        .input_video {
            display: none;
        }

        /* UI æ§ä»¶æ¨£å¼ */
        .ui-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
            box-shadow: 0 6px 8px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 20;
            flex-direction: column;
        }

        .instruction {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.8);
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.7), transparent);
            padding: 10px 40px;
            border-radius: 20px;
            pointer-events: none;
            text-align: center;
            z-index: 5;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        /* éŸ³æ¨‚æ§åˆ¶å€éš±è— */
        .music-player {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-end;
        }
    </style>
</head>
<body>

    <div id="canvas-container">
        <!-- ç•«å¸ƒ -->
        <canvas id="output_canvas"></canvas>
        
        <!-- è¦–é »è¼¸å…¥ (éš±è—) -->
        <video class="input_video"></video>

        <!-- UI æ§ä»¶ -->
        <div class="ui-controls">
            <div class="music-player">
                <label class="btn">
                    <span>ğŸµ ä¸Šè¼‰èƒŒæ™¯éŸ³æ¨‚</span>
                    <input type="file" id="music-upload" accept="audio/*" style="display: none;">
                </label>
                <!-- æ’­æ”¾æ§åˆ¶æŒ‰éˆ• (é»˜èªé¡¯ç¤ºï¼Œä½†ç°è‰²ä¸å¯ç”¨ï¼Œç›´åˆ°ä¸Šè¼‰) -->
                <button class="btn" id="music-toggle" style="display: none; background-color: rgba(100, 255, 100, 0.3);">
                    â–¶ï¸ æ’­æ”¾éŸ³æ¨‚
                </button>
            </div>
            
            <button class="btn" onclick="flowers = [];">
                ğŸ§¹ æ¸…é™¤èŠ±åœ’
            </button>
        </div>

        <!-- æŒ‡å¼•æ–‡å­— -->
        <div class="instruction">
            <p class="text-xl font-light tracking-widest">æåˆæ‰‹æŒ‡æŠ“å–ç¨®å­ Â· æ”¾é–‹æ‰‹æŒ‡ç¶»æ”¾å¥‡è¹Ÿ</p>
        </div>

        <!-- åŠ è¼‰ç•«é¢ -->
        <div class="loading-overlay" id="loading">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div>
            <p>æ­£åœ¨å•Ÿå‹• AI è¦–è¦ºå¼•æ“...</p>
            <p class="text-sm text-gray-400 mt-2">è«‹å…è¨±æ”åƒé ­æ¬Šé™</p>
        </div>
    </div>

    <audio id="bg-music" loop></audio>

    <script>
        // --- è®Šé‡å®šç¾© ---
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingScreen = document.getElementById('loading');
        
        // éŸ³é »æ§åˆ¶
        const musicUpload = document.getElementById('music-upload');
        const musicToggle = document.getElementById('music-toggle');
        const bgMusic = document.getElementById('bg-music');
        let isMusicPlaying = false;

        // æ‡‰ç”¨ç‹€æ…‹
        let width, height;
        let particles = []; // æµæ˜Ÿ
        let flowers = [];   // èŠ±æœµ
        let stars = [];     // èƒŒæ™¯æ˜Ÿæ˜Ÿ
        let handPosition = { x: 0, y: 0, pinch: false };
        let lastPinchState = false; 

        // --- åˆå§‹åŒ– ---
        function resize() {
            width = canvasElement.width = window.innerWidth;
            height = canvasElement.height = window.innerHeight;
            initStars();
        }
        window.addEventListener('resize', resize);
        resize();

        // --- è¦–è¦ºå…ƒç´ é¡åˆ¥ ---

        // 1. èƒŒæ™¯æ˜Ÿæ˜Ÿ
        function initStars() {
            stars = [];
            for(let i=0; i<150; i++) {
                stars.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    size: Math.random() * 1.5,
                    alpha: Math.random(),
                    twinkleSpeed: 0.02 + Math.random() * 0.05
                });
            }
        }

        // 2. æµæ˜Ÿ
        class Meteor {
            constructor() {
                this.reset();
            }
            reset() {
                this.x = Math.random() * width;
                this.y = Math.random() * height * 0.4; 
                this.len = Math.random() * 80 + 20;
                this.speed = Math.random() * 15 + 10;
                this.size = Math.random() * 2 + 0.5;
                this.angle = Math.PI / 4; 
                this.opacity = 0;
                this.active = false;
                if(Math.random() < 0.01) this.active = true;
            }
            update() {
                if(!this.active) {
                    if(Math.random() < 0.008) { 
                        this.active = true;
                        this.opacity = 1;
                        this.x = Math.random() * width;
                        this.y = -100;
                    }
                    return;
                }

                this.x -= this.speed * Math.cos(this.angle); 
                this.y += this.speed * Math.sin(this.angle); 
                this.opacity -= 0.02;

                if (this.y > height || this.x < 0 || this.opacity <= 0) {
                    this.active = false;
                }
            }
            draw() {
                if(!this.active) return;
                canvasCtx.save();
                const grad = canvasCtx.createLinearGradient(this.x, this.y, this.x + this.len * Math.cos(this.angle), this.y - this.len * Math.sin(this.angle));
                grad.addColorStop(0, `rgba(255, 255, 255, ${this.opacity})`);
                grad.addColorStop(1, `rgba(255, 255, 255, 0)`);
                
                canvasCtx.strokeStyle = grad;
                canvasCtx.lineWidth = this.size;
                canvasCtx.lineCap = 'round';
                canvasCtx.beginPath();
                canvasCtx.moveTo(this.x, this.y);
                canvasCtx.lineTo(this.x + this.len * Math.cos(this.angle), this.y - this.len * Math.sin(this.angle)); 
                canvasCtx.stroke();
                
                canvasCtx.shadowBlur = 15;
                canvasCtx.shadowColor = '#FFFFFF';
                canvasCtx.restore();
            }
        }

        for(let i=0; i<6; i++) particles.push(new Meteor());

        // 3. å¤§å¸«ç´šèŠ±æœµé¡åˆ¥
        class Flower {
            constructor(x) {
                this.x = x;
                this.y = height;
                this.targetHeight = Math.random() * 250 + 150;
                this.currentHeight = 0;
                
                // 0: æ«»èŠ± (Sakura)
                // 1: å‘æ—¥è‘µ (Sunflower)
                // 2: ç«ç‘° (Rose)
                // 3: è–°è¡£è‰ (Lavender)
                this.type = Math.floor(Math.random() * 4); 

                // åŸºç¤é¡è‰²èˆ‡åƒæ•¸è¨­ç½®
                if (this.type === 0) { // æ«»èŠ±
                    this.petalColor = '#FFC0CB'; 
                    this.centerColor = '#D81B60'; 
                    this.stemColor = '#5D4037';   
                    this.maxBloomSize = 30 + Math.random() * 5;
                } 
                else if (this.type === 1) { // å‘æ—¥è‘µ
                    this.petalColor = '#FFD700'; 
                    this.centerColor = '#4B3621'; 
                    this.stemColor = '#228B22';   
                    this.maxBloomSize = 45 + Math.random() * 10;
                } 
                else if (this.type === 2) { // ç«ç‘°
                    const r = Math.random();
                    if (r < 0.5) this.petalColor = '#DC143C'; 
                    else if (r < 0.8) this.petalColor = '#FF69B4'; 
                    else this.petalColor = '#FFF0F5'; 
                    
                    this.stemColor = '#006400'; 
                    this.maxBloomSize = 35 + Math.random() * 8;
                } 
                else { // è–°è¡£è‰
                    const r = Math.random();
                    this.petalColor = r > 0.5 ? '#9370DB' : '#7B68EE'; 
                    this.stemColor = '#556B2F'; 
                    this.maxBloomSize = 50; 
                }

                this.currentBloomSize = 0;
                this.swaySpeed = 0.001 + Math.random() * 0.002;
                this.swayOffset = Math.random() * Math.PI * 2;
                
                this.leafLeft = Math.random() > 0.2;
                this.leafRight = Math.random() > 0.2;
            }

            update() {
                if (this.currentHeight < this.targetHeight) {
                    this.currentHeight += (this.targetHeight - this.currentHeight) * 0.05;
                } 
                if (this.currentHeight > this.targetHeight * 0.6) {
                     if (this.currentBloomSize < this.maxBloomSize) {
                        this.currentBloomSize += (this.maxBloomSize - this.currentBloomSize) * 0.04;
                    }
                }
            }

            draw() {
                canvasCtx.save();
                
                const sway = Math.sin(Date.now() * this.swaySpeed + this.swayOffset) * 10;
                const tipX = this.x + sway;
                const tipY = height - this.currentHeight;

                // --- 1. è–èˆ‡è‘‰ ---
                canvasCtx.strokeStyle = this.stemColor;
                canvasCtx.lineCap = 'round';
                
                if (this.type === 1) { // å‘æ—¥è‘µ
                    canvasCtx.lineWidth = 6;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(this.x, height);
                    canvasCtx.quadraticCurveTo(this.x + sway/4, height - this.currentHeight/2, tipX, tipY);
                    canvasCtx.stroke();
                } else if (this.type === 2) { // ç«ç‘°
                    canvasCtx.lineWidth = 4;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(this.x, height);
                    canvasCtx.quadraticCurveTo(this.x + sway, height - this.currentHeight/2, tipX, tipY);
                    canvasCtx.stroke();
                    
                    // ç•«åˆº
                    if (this.currentHeight > 50) {
                        canvasCtx.fillStyle = '#2F4F4F';
                        for(let h = 20; h < this.currentHeight - 30; h += 30) {
                            let tx = this.x + (tipX - this.x) * (h / this.currentHeight);
                            let ty = height - h;
                            let dir = (h % 60 === 0) ? 1 : -1;
                            canvasCtx.beginPath();
                            canvasCtx.moveTo(tx, ty);
                            canvasCtx.lineTo(tx + 6*dir, ty - 2);
                            canvasCtx.lineTo(tx, ty - 6);
                            canvasCtx.fill();
                        }
                    }
                } else if (this.type === 3) { // è–°è¡£è‰
                    canvasCtx.lineWidth = 3;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(this.x, height);
                    canvasCtx.lineTo(tipX, tipY);
                    canvasCtx.stroke();
                } else { // æ«»èŠ±
                    canvasCtx.lineWidth = 4;
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(this.x, height);
                    canvasCtx.quadraticCurveTo(this.x + sway/2, height - this.currentHeight/2, tipX, tipY);
                    canvasCtx.stroke();
                }

                // --- è‘‰å­ (æ–¹å‘èª¿æ•´ï¼šæ”¹ç‚ºå‘ä¸Šç”Ÿé•·) ---
                if (this.currentHeight > 60) {
                    canvasCtx.fillStyle = this.stemColor;
                    
                    if (this.type === 1) { // å‘æ—¥è‘µ
                        const leafSize = 25;
                        this.drawHeartLeaf(this.x + sway*0.2 - 5, height - this.currentHeight * 0.4, -0.8, leafSize);
                        this.drawHeartLeaf(this.x + sway*0.2 + 5, height - this.currentHeight * 0.5, 0.8, leafSize);
                    } 
                    else if (this.type === 2) { // ç«ç‘°
                         const leafSize = 12;
                         if (this.leafLeft) this.drawSerratedLeaf(this.x + sway*0.2, height - this.currentHeight * 0.3, -1, leafSize);
                         if (this.leafRight) this.drawSerratedLeaf(this.x + sway*0.2, height - this.currentHeight * 0.5, 1, leafSize);
                    }
                    else if (this.type === 3) { // è–°è¡£è‰
                         const leafSize = 18;
                         this.drawThinLeaf(this.x, height - 30, -0.6, leafSize);
                         this.drawThinLeaf(this.x, height - 30, 0.6, leafSize);
                         this.drawThinLeaf(this.x, height - 50, -0.5, leafSize * 0.8);
                         this.drawThinLeaf(this.x, height - 50, 0.5, leafSize * 0.8);
                    }
                    else { // æ«»èŠ±
                        if (this.leafLeft) this.drawGenericLeaf(this.x + sway/3 - 5, height - this.currentHeight * 0.3, -1, 10);
                        if (this.leafRight) this.drawGenericLeaf(this.x + sway/3 + 5, height - this.currentHeight * 0.5, 1, 10);
                    }
                }

                // --- 2. èŠ±æœµ ---
                if (this.currentBloomSize > 1) {
                    canvasCtx.translate(tipX, tipY);
                    
                    // 0: æ«»èŠ±
                    if (this.type === 0) { 
                        canvasCtx.rotate(sway * 0.02);
                        canvasCtx.fillStyle = this.petalColor;
                        for(let i=0; i<5; i++) {
                            canvasCtx.save();
                            canvasCtx.rotate(i * Math.PI * 2 / 5);
                            canvasCtx.beginPath();
                            const s = this.currentBloomSize;
                            canvasCtx.moveTo(0,0);
                            canvasCtx.bezierCurveTo(-s*0.3, -s*0.3, -s*0.8, -s*0.8, 0, -s * 1.2); 
                            canvasCtx.lineTo(0, -s * 1.0); 
                            canvasCtx.lineTo(0, -s * 1.2);
                            canvasCtx.bezierCurveTo(s*0.8, -s*0.8, s*0.3, -s*0.3, 0, 0);
                            canvasCtx.fill();
                            canvasCtx.restore();
                        }
                        
                        canvasCtx.fillStyle = '#FF69B4'; 
                        canvasCtx.beginPath();
                        canvasCtx.arc(0, 0, this.currentBloomSize * 0.15, 0, Math.PI*2);
                        canvasCtx.fill();

                        canvasCtx.strokeStyle = this.centerColor;
                        canvasCtx.fillStyle = '#FFFF00'; 
                        canvasCtx.lineWidth = 1;
                        for(let j=0; j<5; j++){
                            canvasCtx.save();
                            canvasCtx.rotate(j * Math.PI * 2 / 5 + Math.PI/5); 
                            canvasCtx.beginPath();
                            canvasCtx.moveTo(0,0);
                            canvasCtx.lineTo(0, this.currentBloomSize * 0.4);
                            canvasCtx.stroke();
                            canvasCtx.beginPath();
                            canvasCtx.arc(0, this.currentBloomSize * 0.4, 2, 0, Math.PI*2);
                            canvasCtx.fill();
                            canvasCtx.restore();
                        }
                    } 
                    
                    // 1: å‘æ—¥è‘µ
                    else if (this.type === 1) { 
                        canvasCtx.rotate(sway * 0.01 + Math.PI/4); 
                        
                        canvasCtx.fillStyle = this.petalColor;
                        const petals = 18;
                        for(let i=0; i<petals; i++) {
                            canvasCtx.rotate(Math.PI * 2 / petals);
                            canvasCtx.beginPath();
                            const len = this.currentBloomSize * 1.1;
                            const wid = this.currentBloomSize * 0.25;
                            canvasCtx.ellipse(0, -len*0.6, wid, len*0.6, 0, 0, Math.PI*2);
                            canvasCtx.fill();
                        }
                        
                        canvasCtx.fillStyle = this.centerColor;
                        canvasCtx.beginPath();
                        canvasCtx.arc(0, 0, this.currentBloomSize * 0.5, 0, Math.PI*2);
                        canvasCtx.fill();
                        
                        canvasCtx.strokeStyle = 'rgba(0,0,0,0.3)';
                        canvasCtx.lineWidth = 1;
                        canvasCtx.beginPath();
                        for(let r=5; r < this.currentBloomSize * 0.5; r+=5) {
                            canvasCtx.moveTo(r, 0);
                            canvasCtx.arc(0, 0, r, 0, Math.PI*2);
                        }
                        canvasCtx.stroke();
                    }
                    
                    // 2: ç«ç‘°
                    else if (this.type === 2) { 
                        canvasCtx.rotate(sway * 0.02);
                        
                        canvasCtx.fillStyle = this.petalColor;
                        canvasCtx.strokeStyle = 'rgba(0,0,0,0.15)'; 
                        canvasCtx.lineWidth = 1;
                        
                        // å¤–å±¤
                        for(let i=0; i<3; i++) {
                            canvasCtx.save();
                            canvasCtx.rotate(i * Math.PI * 2 / 3);
                            canvasCtx.beginPath();
                            canvasCtx.arc(0, -this.currentBloomSize * 0.4, this.currentBloomSize * 0.6, 0, Math.PI, true);
                            canvasCtx.fill();
                            canvasCtx.stroke();
                            canvasCtx.restore();
                        }

                        // ä¸­å±¤
                        canvasCtx.save();
                        canvasCtx.rotate(Math.PI/3); 
                        for(let i=0; i<3; i++) {
                            canvasCtx.save();
                            canvasCtx.rotate(i * Math.PI * 2 / 3);
                            canvasCtx.beginPath();
                            canvasCtx.arc(0, -this.currentBloomSize * 0.3, this.currentBloomSize * 0.4, 0, Math.PI, true);
                            canvasCtx.fill();
                            canvasCtx.stroke();
                            canvasCtx.restore();
                        }
                        canvasCtx.restore();

                        // ä¸­å¿ƒå¯¦å¿ƒ
                        canvasCtx.fillStyle = this.petalColor; 
                        canvasCtx.beginPath();
                        canvasCtx.arc(0, 0, this.currentBloomSize * 0.35, 0, Math.PI * 2);
                        canvasCtx.fill();

                        // èºæ—‹
                        canvasCtx.strokeStyle = '#8B0000'; 
                        canvasCtx.lineWidth = 1.5;
                        canvasCtx.beginPath();
                        for(let r=2; r < this.currentBloomSize * 0.3; r+=3) {
                            canvasCtx.moveTo(r, 0);
                            canvasCtx.arc(0, 0, r, 0, Math.PI * 1.5);
                        }
                        canvasCtx.stroke();
                    }

                    // 3: è–°è¡£è‰
                    else if (this.type === 3) {
                        canvasCtx.rotate(-sway * 0.02); 
                        canvasCtx.fillStyle = this.petalColor;
                        
                        const spikeHeight = this.currentBloomSize * 1.5;
                        const layers = 10;
                        
                        for(let i=0; i<layers; i++) {
                            const yPos = -i * (spikeHeight/layers); 
                            const scale = 1 - (i / layers) * 0.6;
                            const wid = 8 * scale;
                            const hgt = 10 * scale;

                            canvasCtx.beginPath();
                            canvasCtx.ellipse(-wid/1.5, yPos, wid, hgt, -0.3, 0, Math.PI*2);
                            canvasCtx.fill();

                            canvasCtx.beginPath();
                            canvasCtx.ellipse(wid/1.5, yPos, wid, hgt, 0.3, 0, Math.PI*2);
                            canvasCtx.fill();

                            canvasCtx.beginPath();
                            canvasCtx.ellipse(0, yPos - 2, wid, hgt, 0, 0, Math.PI*2);
                            canvasCtx.fill();
                        }
                    }
                    
                    canvasCtx.restore();
                }
                
                canvasCtx.restore();
            }

            // --- è‘‰å­ç¹ªè£½è¼”åŠ©å‡½æ•¸ (æ›´æ–°ï¼šå‘ä¸Šç”Ÿé•·) ---
            
            drawHeartLeaf(x, y, dir, size) {
                // å‘æ—¥è‘µçš„å¤§è‘‰å­
                canvasCtx.save();
                canvasCtx.translate(x, y);
                // èª¿æ•´è§’åº¦ï¼Œä½¿å…¶æŒ‡å‘æ–œä¸Šæ–¹
                canvasCtx.rotate(dir * 0.8); 
                canvasCtx.beginPath();
                canvasCtx.moveTo(0,0);
                // ç¿»è½‰ Y è»¸åº§æ¨™ (ä½¿ç”¨è² å€¼)
                canvasCtx.bezierCurveTo(-size, -(-size*0.5), -size, -size*1.5, 0, -size*2.0);
                canvasCtx.bezierCurveTo(size, -size*1.5, size, -(-size*0.5), 0, 0);
                canvasCtx.fill();
                
                canvasCtx.strokeStyle = 'rgba(0,0,0,0.2)';
                canvasCtx.lineWidth = 1;
                canvasCtx.stroke();
                canvasCtx.restore();
            }

            drawSerratedLeaf(x, y, dir, size) {
                // ç«ç‘°çš„é‹¸é½’è‘‰
                canvasCtx.save();
                canvasCtx.translate(x, y);
                canvasCtx.rotate(dir * 1.0);
                canvasCtx.beginPath();
                canvasCtx.moveTo(0,0);
                
                const steps = 5;
                const len = size * 2;
                // å·¦é‚Š (Y å€¼å–è² ï¼Œä½¿å…¶å‘ä¸Š)
                for(let i=1; i<=steps; i++) {
                    let lx = -size/2 * Math.sin(i/steps * Math.PI);
                    let ly = -i * (len/steps); // è² å€¼
                    canvasCtx.lineTo(lx, ly); 
                    canvasCtx.lineTo(lx + 2, ly + 2); // å›ç¸®æ–¹å‘èª¿æ•´
                }
                canvasCtx.lineTo(0, -len - 5); // è‘‰å°–

                // å³é‚Š
                for(let i=steps; i>=1; i--) {
                    let rx = size/2 * Math.sin(i/steps * Math.PI);
                    let ly = -i * (len/steps); // è² å€¼
                    canvasCtx.lineTo(rx + 2, ly + 2); 
                    canvasCtx.lineTo(rx, ly); 
                }
                canvasCtx.closePath();
                canvasCtx.fill();
                canvasCtx.restore();
            }

            drawThinLeaf(x, y, dir, size) {
                // è–°è¡£è‰çš„ç´°é•·è‘‰
                canvasCtx.save();
                canvasCtx.translate(x, y);
                canvasCtx.rotate(dir * 0.8);
                canvasCtx.beginPath();
                // ä¸­å¿ƒå‘ä¸Šç§»å‹• (-size)
                canvasCtx.ellipse(0, -size, size/6, size * 1.2, 0, 0, Math.PI*2);
                canvasCtx.fill();
                canvasCtx.restore();
            }

            drawGenericLeaf(x, y, dir, size) {
                canvasCtx.save();
                canvasCtx.translate(x, y);
                canvasCtx.rotate(dir * 0.8); // ç¨å¾®æ›´å‘å¤–
                canvasCtx.beginPath();
                // è‘‰å­æŒ‡å‘å¤–ä¸Šæ–¹ (0, -size)
                canvasCtx.ellipse(0, -size/2, size, size/2, Math.PI/2, 0, Math.PI*2);
                canvasCtx.fill();
                canvasCtx.restore();
            }
        }

        // --- ä¸»ç¹ªåœ–å¾ªç’° ---
        function drawScene() {
            // èƒŒæ™¯
            canvasCtx.fillStyle = 'black';
            canvasCtx.fillRect(0, 0, width, height);

            // æ˜Ÿæ˜Ÿ
            stars.forEach(star => {
                canvasCtx.fillStyle = `rgba(255, 255, 255, ${star.alpha * (0.5 + Math.sin(Date.now() * star.twinkleSpeed) * 0.5)})`;
                canvasCtx.beginPath();
                canvasCtx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                canvasCtx.fill();
            });

            // æœˆäº®
            const moonX = width - 100; 
            const moonY = 100;
            const glow = canvasCtx.createRadialGradient(moonX, moonY, 35, moonX, moonY, 120);
            glow.addColorStop(0, 'rgba(255, 255, 240, 0.4)');
            glow.addColorStop(1, 'rgba(255, 255, 240, 0)');
            canvasCtx.fillStyle = glow;
            canvasCtx.beginPath();
            canvasCtx.arc(moonX, moonY, 120, 0, Math.PI * 2);
            canvasCtx.fill();

            canvasCtx.fillStyle = '#FFFFF0';
            canvasCtx.shadowColor = '#FFFFF0';
            canvasCtx.shadowBlur = 20;
            canvasCtx.beginPath();
            canvasCtx.arc(moonX, moonY, 40, 0, Math.PI * 2);
            canvasCtx.fill();
            canvasCtx.shadowBlur = 0; 

            // æµæ˜Ÿ
            particles.forEach(p => {
                p.update();
                p.draw();
            });

            // èŠ±æœµ
            flowers.forEach(flower => {
                flower.update();
                flower.draw();
            });

            // æ‰‹å‹¢è¦–è¦ºåé¥‹
            if (handPosition.visible) {
                const x = handPosition.x * width;
                const y = handPosition.y * height;

                canvasCtx.shadowBlur = 15;
                canvasCtx.shadowColor = handPosition.pinch ? '#00FF88' : '#FF77FF';
                
                if (handPosition.pinch) {
                    canvasCtx.fillStyle = '#CCFFCC';
                    canvasCtx.beginPath();
                    canvasCtx.arc(x, y, 8 + Math.sin(Date.now()*0.02)*2, 0, Math.PI * 2);
                    canvasCtx.fill();
                    
                    canvasCtx.font = "24px Arial";
                    canvasCtx.fillStyle = "white";
                    canvasCtx.save();
                    canvasCtx.scale(-1, 1); 
                    canvasCtx.fillText("ğŸŒ±", -x - 10, y - 30);
                    canvasCtx.restore();

                } else {
                    canvasCtx.strokeStyle = `rgba(255, 255, 255, 0.8)`;
                    canvasCtx.lineWidth = 2;
                    canvasCtx.setLineDash([4, 4]);
                    canvasCtx.beginPath();
                    canvasCtx.arc(x, y, 25, 0, Math.PI * 2);
                    canvasCtx.stroke();
                    canvasCtx.setLineDash([]);
                    
                    canvasCtx.fillStyle = 'white';
                    canvasCtx.beginPath();
                    canvasCtx.arc(x, y, 4, 0, Math.PI * 2);
                    canvasCtx.fill();
                }
                canvasCtx.shadowBlur = 0;
            }
        }

        // --- MediaPipe é‚è¼¯ ---
        function onResults(results) {
            loadingScreen.style.display = 'none';
            handPosition.visible = false;

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const thumbTip = landmarks[4];
                const indexTip = landmarks[8];

                const distance = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
                const isPinching = distance < 0.06;

                handPosition = {
                    x: indexTip.x,
                    y: indexTip.y,
                    pinch: isPinching,
                    visible: true
                };

                if (lastPinchState === true && isPinching === false) {
                    plantFlower(handPosition.x * width);
                }
                lastPinchState = isPinching;
            }
            drawScene();
        }

        function plantFlower(x) {
            if (flowers.length > 40) flowers.shift();
            flowers.push(new Flower(x));
        }

        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });
        camera.start();

        // --- éŸ³é » ---
        musicUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                bgMusic.src = url;
                bgMusic.play();
                isMusicPlaying = true;
                
                // é¡¯ç¤ºæ’­æ”¾æŒ‰éˆ•ï¼Œæ›´æ–°ç‹€æ…‹
                musicToggle.style.display = 'flex';
                musicToggle.style.backgroundColor = ''; // ç§»é™¤ç°åº•
                musicToggle.innerHTML = 'â¸ï¸ æš«åœéŸ³æ¨‚';
            }
        });

        musicToggle.addEventListener('click', function() {
            if (bgMusic.src) {
                if (bgMusic.paused) {
                    bgMusic.play();
                    musicToggle.innerHTML = 'â¸ï¸ æš«åœéŸ³æ¨‚';
                } else {
                    bgMusic.pause();
                    musicToggle.innerHTML = 'â–¶ï¸ æ’­æ”¾éŸ³æ¨‚';
                }
            } else {
                // å¦‚æœé‚„æ²’æœ‰éŸ³æ¨‚ï¼Œè§¸ç™¼ä¸Šè¼‰
                musicUpload.click();
            }
        });

    </script>
</body>
</html>