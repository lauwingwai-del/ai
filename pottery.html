<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>é™¶è—å¤§å¸« AI ç‰ˆ - 3D æ‰‹ä½œé™¶ç“·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Markdown parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; font-family: 'Noto Sans TC', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; cursor: crosshair; }
        
        /* Glassmorphism Panel */
        .ui-panel {
            position: absolute;
            z-index: 10;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.3s ease;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }

        @media (max-width: 768px) {
            .controls-sidebar {
                bottom: 0; left: 0; right: 0; top: auto;
                width: 100%; height: 45vh;
                border-radius: 1.5rem 1.5rem 0 0;
                padding: 1.5rem;
            }
        }
        
        .shape-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .shape-btn {
            font-size: 0.8rem; padding: 0.5rem; background: rgba(0,0,0,0.05);
            border-radius: 0.5rem; transition: all 0.2s; text-align: center;
        }
        .shape-btn:hover { background: rgba(0,0,0,0.1); transform: translateY(-1px); }
        .shape-btn.active { background: #4F46E5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); }

        /* AI Modal Styles */
        .ai-modal {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #4F46E5; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
    </style>
</head>
<body>

    <!-- Canvas -->
    <div id="canvas-container"></div>

    <!-- Header -->
    <div class="absolute top-6 left-6 z-20 pointer-events-none select-none">
        <h1 class="text-4xl font-black text-white tracking-widest drop-shadow-[0_2px_10px_rgba(0,0,0,0.5)]">é™¶è—<span class="text-indigo-400">å¤§å¸«</span></h1>
        <p class="text-gray-300 mt-2 text-sm font-light tracking-wide bg-black/30 px-3 py-1 rounded-full inline-block backdrop-blur-sm">
            âœ¨ Gemini AI è³¦èƒ½ç‰ˆ
        </p>
    </div>

    <!-- Controls Panel -->
    <div class="ui-panel right-6 top-6 bottom-6 w-80 flex flex-col overflow-hidden controls-sidebar">
        
        <div class="flex-1 overflow-y-auto custom-scroll p-6 space-y-6">
            
            <!-- AI Features Section (New) -->
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100">
                <h3 class="text-indigo-800 font-bold mb-3 flex items-center text-sm uppercase tracking-wider">
                    <span class="text-lg mr-2">âœ¨</span> Gemini AI å¯¦é©—å®¤
                </h3>
                <div class="space-y-2">
                    <button onclick="triggerAIAppraisal()" id="btn-appraise" class="w-full py-2.5 bg-white hover:bg-indigo-50 text-indigo-700 border border-indigo-200 rounded-lg text-sm font-bold shadow-sm transition flex items-center justify-center gap-2">
                        <span>ğŸ§</span> åå®¶é‘‘è³ (åˆ†æä½œå“)
                    </button>
                    <button onclick="triggerAIInspiration()" id="btn-inspire" class="w-full py-2.5 bg-white hover:bg-purple-50 text-purple-700 border border-purple-200 rounded-lg text-sm font-bold shadow-sm transition flex items-center justify-center gap-2">
                        <span>ğŸ’¡</span> éˆæ„ŸæŒ‘æˆ° (éš¨æ©Ÿé¡Œç›®)
                    </button>
                </div>
            </div>

            <!-- Shapes Section -->
            <div>
                <h3 class="text-gray-800 font-bold mb-4 flex items-center text-sm uppercase tracking-wider">
                    <span class="w-2 h-2 bg-indigo-500 rounded-full mr-2"></span>
                    é¸æ“‡åŸºåº•å½¢ç‹€
                </h3>
                <div class="shape-grid" id="shape-container"></div>
            </div>

            <!-- Colors Section -->
            <div>
                <h3 class="text-gray-800 font-bold mb-4 flex items-center text-sm uppercase tracking-wider">
                    <span class="w-2 h-2 bg-pink-500 rounded-full mr-2"></span>
                    é‡‰è‰²
                </h3>
                <div class="grid grid-cols-5 gap-3">
                    <button onclick="changeColor('#8B5A2B')" class="aspect-square rounded-full bg-[#8B5A2B] ring-2 ring-white/50 hover:scale-110 transition shadow-sm"></button>
                    <button onclick="changeColor('#A0522D')" class="aspect-square rounded-full bg-[#A0522D] ring-2 ring-white/50 hover:scale-110 transition shadow-sm"></button>
                    <button onclick="changeColor('#dcb188')" class="aspect-square rounded-full bg-[#dcb188] ring-2 ring-white/50 hover:scale-110 transition shadow-sm"></button>
                    <button onclick="changeColor('#E6E6FA')" class="aspect-square rounded-full bg-[#E6E6FA] ring-2 ring-white/50 hover:scale-110 transition shadow-sm"></button>
                    <button onclick="changeColor('#2F4F4F')" class="aspect-square rounded-full bg-[#2F4F4F] ring-2 ring-white/50 hover:scale-110 transition shadow-sm"></button>
                    <button onclick="changeColor('#4682B4')" class="aspect-square rounded-full bg-[#4682B4] ring-2 ring-white/50 hover:scale-110 transition shadow-sm"></button>
                    <button onclick="changeColor('#556B2F')" class="aspect-square rounded-full bg-[#556B2F] ring-2 ring-white/50 hover:scale-110 transition shadow-sm"></button>
                    <button onclick="changeColor('#800000')" class="aspect-square rounded-full bg-[#800000] ring-2 ring-white/50 hover:scale-110 transition shadow-sm"></button>
                    <button onclick="changeColor('#111827')" class="aspect-square rounded-full bg-gray-900 ring-2 ring-white/50 hover:scale-110 transition shadow-sm"></button>
                    <button onclick="changeColor('#ffffff')" class="aspect-square rounded-full bg-white ring-1 ring-gray-300 hover:scale-110 transition shadow-sm"></button>
                </div>
            </div>

            <!-- Material Section -->
            <div>
                <h3 class="text-gray-800 font-bold mb-4 flex items-center text-sm uppercase tracking-wider">
                    <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                    è³ªæ„Ÿ
                </h3>
                <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                    <button onclick="setGlossiness(0.9, 0.0)" class="flex-1 py-2 rounded-md text-xs font-medium transition hover:bg-white hover:shadow-sm text-gray-600 focus:bg-white focus:text-indigo-600 focus:shadow-sm">ç²—ç³™é™¶åœŸ</button>
                    <button onclick="setGlossiness(0.3, 0.6)" class="flex-1 py-2 rounded-md text-xs font-medium transition hover:bg-white hover:shadow-sm text-gray-600 focus:bg-white focus:text-indigo-600 focus:shadow-sm">åŠå…‰æ¾¤</button>
                    <button onclick="setGlossiness(0.05, 1.0)" class="flex-1 py-2 rounded-md text-xs font-medium transition hover:bg-white hover:shadow-sm text-gray-600 focus:bg-white focus:text-indigo-600 focus:shadow-sm">äº®é¢ç“·é‡‰</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-6 pt-0 mt-auto bg-gradient-to-t from-white/90 to-transparent">
            <button onclick="exportImage()" class="w-full py-3.5 bg-gradient-to-r from-gray-700 to-black hover:from-gray-600 hover:to-gray-900 text-white rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                æ‹æ”æˆå“
            </button>
            <button onclick="resetShape(currentShapeType)" class="mt-3 w-full py-2 text-gray-500 hover:text-red-500 text-xs font-medium transition flex items-center justify-center gap-1">
                é‡ç½®ç•¶å‰å½¢ç‹€
            </button>
        </div>
    </div>

    <!-- AI Result Modal -->
    <div id="ai-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden ai-modal transform transition-all">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 flex justify-between items-center text-white">
                <h3 id="modal-title" class="font-bold text-lg flex items-center gap-2">âœ¨ Gemini åˆ†æçµæœ</h3>
                <button onclick="closeModal()" class="hover:bg-white/20 rounded-full p-1 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div id="loading-state" class="hidden flex flex-col items-center justify-center py-8 text-center space-y-4">
                    <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                    <p class="text-indigo-600 font-medium animate-pulse">Gemini æ­£åœ¨ä»”ç´°ç«¯è©³æ‚¨çš„ä½œå“...</p>
                </div>
                <div id="modal-content" class="markdown-body text-gray-700 text-sm"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium transition">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Interaction Visual Guide -->
    <div id="hand-guide" class="fixed pointer-events-none hidden z-30 transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center">
        <div class="absolute w-full h-full border-2 border-white/80 rounded-full animate-pulse shadow-[0_0_20px_rgba(255,255,255,0.6)]"></div>
        <div class="w-2 h-2 bg-white rounded-full"></div>
    </div>

    <script>
        // --- GEMINI API CONFIG ---
        const apiKey = ""; // System provides this at runtime

        async function callGeminiAPI(promptText, base64Image = null) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const parts = [{ text: promptText }];
            
            if (base64Image) {
                // Remove data:image/png;base64, prefix if present
                const cleanBase64 = base64Image.replace(/^data:image\/(png|jpeg);base64,/, "");
                parts.push({
                    inlineData: {
                        mimeType: "image/png",
                        data: cleanBase64
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "æŠ±æ­‰ï¼ŒGemini ä¼¼ä¹æ­£åœ¨ä¼‘æ¯ï¼ˆé€£ç·šéŒ¯èª¤ï¼‰ã€‚è«‹ç¨å¾Œå†è©¦ã€‚";
            }
        }

        // --- AI FEATURES UI LOGIC ---

        function showModal(title) {
            const modal = document.getElementById('ai-modal');
            const modalTitle = document.getElementById('modal-title');
            const loading = document.getElementById('loading-state');
            const content = document.getElementById('modal-content');
            
            modalTitle.innerHTML = title;
            content.innerHTML = '';
            loading.classList.remove('hidden');
            modal.classList.remove('hidden');
            // Trigger reflow for animation
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
        }

        function updateModalContent(markdownText) {
            const loading = document.getElementById('loading-state');
            const content = document.getElementById('modal-content');
            loading.classList.add('hidden');
            content.innerHTML = marked.parse(markdownText);
        }

        function closeModal() {
            const modal = document.getElementById('ai-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        async function triggerAIAppraisal() {
            showModal('âœ¨ Gemini åå®¶é‘‘è³');
            
            // 1. Capture the canvas
            renderer.render(scene, camera);
            const dataURL = renderer.domElement.toDataURL('image/png', 0.8);

            // 2. Formulate Prompt
            const prompt = `ä½ æ˜¯ä¸€ä½ä¸–ç•Œèåçš„é™¶è—é‘‘è³å¤§å¸«ï¼Œè¬›è©±é¢¨æ ¼å„ªé›…ã€å°ˆæ¥­ï¼Œå¶çˆ¾å¸¶é»å¹½é»˜ã€‚
            è«‹ä»”ç´°è§€å¯Ÿé€™ä»¶é™¶è—ä½œå“çš„åœ–ç‰‡ï¼ˆå½¢ç‹€ã€ç·šæ¢ã€é¡è‰²ã€è³ªæ„Ÿï¼‰ã€‚
            
            è«‹ä»¥ Markdown æ ¼å¼è¼¸å‡ºä»¥ä¸‹å…§å®¹ï¼š
            1. **ã€å“åã€‘**ï¼šç‚ºå®ƒå–ä¸€å€‹æ¥µå…·è©©æ„æˆ–æ„å¢ƒçš„åå­—ï¼ˆä¾‹å¦‚ï¼šè«è˜­è¿ªçš„å˜†æ¯ã€æ·±æµ·ä¹‹æ­Œï¼‰ã€‚
            2. **ã€é‘‘è³é»è©•ã€‘**ï¼šæè¿°å®ƒçš„é€ å‹ç‰¹é»ã€‚å®ƒçš„ç·šæ¢æ˜¯åœ“æ½¤é‚„æ˜¯éŠ³åˆ©ï¼Ÿçµ¦äººçš„æ„Ÿè¦ºæ˜¯ç©©é‡é‚„æ˜¯è¼•ç›ˆï¼Ÿé‡‰è‰²å¦‚ä½•ï¼Ÿ(100å­—ä»¥å…§)
            3. **ã€é©åˆå ´æ™¯ã€‘**ï¼šé€™ä»¶ä½œå“é©åˆæ”¾åœ¨å“ªè£¡ï¼Ÿï¼ˆä¾‹å¦‚ï¼šå¤è€çš„åœ–æ›¸é¤¨ã€ç¾ä»£ç¾è¡“é¤¨çš„è§’è½ã€æˆ–æ˜¯å¤–æ˜Ÿäººçš„é¤æ¡Œï¼‰ã€‚
            4. **ã€ä¼°åƒ¹ã€‘**ï¼šçµ¦å‡ºä¸€å€‹æœ‰è¶£çš„æ‹è³£ä¼°åƒ¹ï¼ˆå¯ä»¥æ˜¯è²¨å¹£ï¼Œä¹Ÿå¯ä»¥æ˜¯å¥‡å¹»çš„ä»£åƒ¹ï¼Œä¾‹å¦‚ã€Œä¸‰å€‹é¡˜æœ›ã€æˆ–ã€Œä¸€è¬æšé‡‘å¹£ã€ï¼‰ã€‚`;

            // 3. Call API
            const result = await callGeminiAPI(prompt, dataURL);
            updateModalContent(result);
        }

        async function triggerAIInspiration() {
            showModal('ğŸ’¡ Gemini éˆæ„ŸæŒ‘æˆ°');
            
            const prompt = `ä½ æ˜¯ä¸€ä½åš´æ ¼ä½†å¯Œæœ‰å‰µæ„çš„é™¶è—å°å¸«ã€‚è«‹çµ¦æˆ‘ä¸€å€‹éš¨æ©Ÿçš„é™¶è—å‰µä½œé¡Œç›®ã€‚
            
            è«‹ä»¥ Markdown æ ¼å¼è¼¸å‡ºï¼š
            1. **ã€ä»Šæ—¥æŒ‘æˆ°é¡Œç›®ã€‘**ï¼šä¸€å€‹æœ‰è¶£çš„é¡Œç›®åç¨±ï¼ˆä¾‹å¦‚ï¼šçµ¦å·¨äººçš„é…’æ¯ã€é¢¨ä¹‹å½¢ç‹€ã€ä¸å°ç¨±çš„ç¾å­¸ï¼‰ã€‚
            2. **ã€é€ å‹è¦æ±‚ã€‘**ï¼šå…·é«”æè¿°å½¢ç‹€çš„è¦æ±‚ï¼ˆä¾‹å¦‚ï¼šåº•éƒ¨æ¥µçª„ä½†é ‚éƒ¨å¯¬é—Šã€å¿…é ˆæœ‰æ˜é¡¯çš„æ›²ç·šè®ŠåŒ–ã€æˆ–æ˜¯æ¨¡ä»¿æŸç¨®æ°´æœçš„å½¢ç‹€ï¼‰ã€‚
            3. **ã€é¢¨æ ¼é—œéµè©ã€‘**ï¼š3å€‹é¢¨æ ¼å½¢å®¹è©ï¼ˆä¾‹å¦‚ï¼šæ¥µç°¡ã€ç‹‚é‡ã€è³½åšé¾å…‹ï¼‰ã€‚
            4. **ã€å°å¸«å¯„èªã€‘**ï¼šä¸€å¥é¼“å‹µçš„è©±ã€‚
            
            è«‹ä¿æŒéš¨æ©Ÿæ€§ï¼Œæ¯æ¬¡éƒ½ä¸ä¸€æ¨£ã€‚`;

            const result = await callGeminiAPI(prompt);
            updateModalContent(result);
        }

        // --- DATA: 10 SHAPES ---
        const SHAPES = [
            { id: 'cylinder', name: 'åŸºç¤åœ“æŸ±' },
            { id: 'vase', name: 'ç¶“å…¸èŠ±ç“¶' },
            { id: 'bowl', name: 'æ—¥å¼å¯¬ç¢—' },
            { id: 'gourd', name: 'å‰ç¥¥è‘«è˜†' },
            { id: 'sake', name: 'æ¸…é…’å£º' },
            { id: 'trumpet', name: 'å–‡å­èŠ±ç“¶' },
            { id: 'urn', name: 'åœ“æ½¤é™¶ç”•' },
            { id: 'hourglass', name: 'ç´°è…°æ²™æ¼' },
            { id: 'chalice', name: 'é«˜è…³è–æ¯' },
            { id: 'planter', name: 'å¹¾ä½•èŠ±ç›†' }
        ];

        let currentShapeType = 'cylinder';

        // Render Shape Buttons
        const shapeContainer = document.getElementById('shape-container');
        SHAPES.forEach(shape => {
            const btn = document.createElement('button');
            btn.className = 'shape-btn';
            btn.innerText = shape.name;
            btn.onclick = () => {
                document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                resetShape(shape.id);
            };
            if(shape.id === 'cylinder') btn.classList.add('active');
            shapeContainer.appendChild(btn);
        });

        // --- THREE.JS SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.Fog(0x111111, 15, 60);

        const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 12, 28);
        camera.lookAt(0, 5, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.physicallyCorrectLights = true;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        renderer.outputEncoding = THREE.sRGBEncoding;
        container.appendChild(renderer.domElement);

        // --- LIGHTING ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xffeeb1, 2);
        mainLight.position.set(10, 15, 10);
        mainLight.castShadow = true;
        mainLight.shadow.mapSize.width = 2048;
        mainLight.shadow.mapSize.height = 2048;
        mainLight.shadow.bias = -0.001;
        scene.add(mainLight);

        const fillLight = new THREE.DirectionalLight(0xcceeff, 0.8);
        fillLight.position.set(-10, 8, 5);
        scene.add(fillLight);

        const rimLight = new THREE.SpotLight(0xffffff, 5);
        rimLight.position.set(0, 20, -10);
        rimLight.lookAt(0, 5, 0);
        scene.add(rimLight);

        // --- ENVIRONMENT (Wheel) ---
        const wheelGroup = new THREE.Group();
        scene.add(wheelGroup);

        const wheelGeo = new THREE.CylinderGeometry(9, 10, 1.5, 64);
        const wheelMat = new THREE.MeshStandardMaterial({ 
            color: 0x222222, 
            roughness: 0.7, 
            metalness: 0.8 
        });
        const wheel = new THREE.Mesh(wheelGeo, wheelMat);
        wheel.position.y = -0.75;
        wheel.receiveShadow = true;
        wheelGroup.add(wheel);
        
        const ringGeo = new THREE.TorusGeometry(6, 0.05, 16, 100);
        const ringMesh = new THREE.Mesh(ringGeo, new THREE.MeshBasicMaterial({ color: 0x444444 }));
        ringMesh.rotation.x = Math.PI / 2;
        ringMesh.position.y = 0.01;
        wheelGroup.add(ringMesh);

        // --- POTTERY LOGIC ---
        let geometry, material, mesh;
        let points = [];
        const numPoints = 80;
        const height = 14;
        const radialSegments = 128;

        material = new THREE.MeshPhysicalMaterial({
            color: 0x8B5A2B,
            metalness: 0.0,
            roughness: 0.3,
            clearcoat: 0.1,
            clearcoatRoughness: 0.2,
            side: THREE.DoubleSide,
            flatShading: false
        });

        function createProfile(type) {
            points = [];
            for (let i = 0; i < numPoints; i++) {
                const t = i / (numPoints - 1);
                const y = t * height;
                let x = 3;

                switch (type) {
                    case 'cylinder': x = 3; break;
                    case 'vase': x = 3 + Math.sin(t * Math.PI * 2) * 1.5 - (t * 1.5); if (x < 1.5) x = 1.5; break;
                    case 'bowl': x = 2.5 + Math.pow(t, 0.7) * 5; break;
                    case 'gourd': 
                        x = 2.5 + (Math.sin(t * Math.PI * 3 - Math.PI/2) + 1) * 1.5;
                        if (t > 0.4 && t < 0.6) x *= 0.6;
                        if (t > 0.9) x *= 0.7;
                        break;
                    case 'sake':
                        if (t < 0.4) { x = 4 * Math.sin(t / 0.4 * Math.PI); } else { x = 1.0; }
                        if (x < 1) x = 1; if (t < 0.05) x = 2 + t*10;
                        break;
                    case 'trumpet': x = 2 + Math.pow(t, 2) * 4; break;
                    case 'urn': x = 3 + Math.sin(t * Math.PI) * 3; break;
                    case 'hourglass': x = 4 - Math.sin(t * Math.PI) * 2; break;
                    case 'chalice':
                        if (t < 0.4) { x = 0.8; if (t < 0.05) x = 3 * (1-t/0.05); } 
                        else { const t2 = (t - 0.4) / 0.6; x = 1.5 + t2 * 3; }
                        break;
                    case 'planter': x = 2.5 + t * 2; break;
                }
                if (x < 0.2) x = 0.2;
                points.push(new THREE.Vector2(x, y));
            }
        }

        function updateGeometry() {
            if (mesh) { scene.remove(mesh); geometry.dispose(); }
            geometry = new THREE.LatheGeometry(points, radialSegments);
            geometry.computeVertexNormals();
            mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true; mesh.receiveShadow = true; mesh.position.y = 0;
            scene.add(mesh);
        }

        createProfile('cylinder');
        updateGeometry();

        // --- INTERACTION LOGIC ---
        let isDragging = false;
        let mouse = new THREE.Vector2();
        let raycaster = new THREE.Raycaster();
        const guideDiv = document.getElementById('hand-guide');

        function getInteractPosition(clientX, clientY) {
            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const target = new THREE.Vector3();
            raycaster.ray.intersectPlane(new THREE.Plane(new THREE.Vector3(0, 0, 1), 0), target);
            return target;
        }

        function onStart(e) {
            if (e.target.closest('.ui-panel') || e.target.closest('#ai-modal')) return;
            isDragging = true;
            handleInteraction(e);
        }

        function onEnd() { isDragging = false; guideDiv.classList.add('hidden'); }
        function onMove(e) { if (!isDragging) return; handleInteraction(e); }

        function handleInteraction(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            guideDiv.classList.remove('hidden');
            guideDiv.style.left = clientX + 'px';
            guideDiv.style.top = clientY + 'px';

            const worldPos = getInteractPosition(clientX, clientY);
            const targetY = Math.max(0, Math.min(height, worldPos.y));
            let targetRadius = Math.abs(worldPos.x);
            
            deformMesh(targetY, targetRadius);
            
            guideDiv.style.width = (targetRadius * 30 + 20) + 'px';
            guideDiv.style.height = (targetRadius * 10 + 20) + 'px';
        }

        function deformMesh(targetY, targetRadius) {
            const indexFloat = (targetY / height) * (numPoints - 1);
            const range = 8;
            for (let i = 0; i < numPoints; i++) {
                const dist = Math.abs(i - indexFloat);
                if (dist < range) {
                    const falloff = 0.5 * (1 + Math.cos(Math.PI * dist / range));
                    const lerpFactor = 0.12;
                    let newRadius = points[i].x + (targetRadius - points[i].x) * falloff * lerpFactor;
                    if (newRadius < 0.2) newRadius = 0.2;
                    if (newRadius > 10) newRadius = 10;
                    points[i].setX(newRadius);
                }
            }
            updateGeometry();
        }

        window.addEventListener('mousedown', onStart);
        window.addEventListener('mouseup', onEnd);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('touchstart', onStart, {passive: false});
        window.addEventListener('touchend', onEnd);
        window.addEventListener('touchmove', (e) => { e.preventDefault(); onMove(e); }, {passive: false});
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function animate() {
            requestAnimationFrame(animate);
            const speed = 0.02;
            if (mesh) mesh.rotation.y -= speed;
            wheelGroup.rotation.y -= speed;
            renderer.render(scene, camera);
        }
        animate();

        window.resetShape = function(type) {
            currentShapeType = type;
            createProfile(type);
            updateGeometry();
        };

        window.changeColor = function(colorStr) { material.color.set(colorStr); };

        window.setGlossiness = function(roughness, clearcoat) {
            material.roughness = roughness;
            material.clearcoat = clearcoat;
            material.clearcoatRoughness = roughness * 0.5;
            material.needsUpdate = true;
        };

        window.exportImage = function() {
            renderer.render(scene, camera);
            const dataURL = renderer.domElement.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `pottery_${currentShapeType}_${Date.now()}.png`;
            link.href = dataURL;
            link.click();
        };

    </script>
</body>
</html>